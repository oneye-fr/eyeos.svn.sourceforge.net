
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>RPC (Remote Procedure Call) &mdash; qooxdoo v1.3 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.3',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="qooxdoo v1.3 documentation" href="../../index.html" />
    <link rel="up" title="Communication" href="../communication.html" />
    <link rel="next" title="Java RPC" href="rpc_java.html" />
    <link rel="prev" title="AJAX" href="remote_io.html" /> 
  </head>
  <body>

		<div class="header">
			<div class="headcenter">
		    <a href="/"><img id="logo" src="http://resources.qooxdoo.org/images/logo.gif" alt="qooxdoo logo"/></a>
		
		    <h1 style="display: none;">qooxdoo</h1>
		    <h2 class="subline">the new era of web development</h2>
		  </div>
			<div class="navigation">
				<a href="http://qooxdoo.org">Home</a>
				<a href="http://qooxdoo.org/about">About</a>
				<a href="http://news.qooxdoo.org/">News</a>
				<a href="http://qooxdoo.org/demo">Demo</a>
				<a class="current" href="http://qooxdoo.org/documentation">Documentation</a>
				<a href="http://qooxdoo.org/community">Community</a>
				<a href="http://qooxdoo.org/download">Download</a>
				<a href="http://bugzilla.qooxdoo.org/">Bugs</a>
			</div>
			<div class="subheader">&nbsp;</div>
		</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="rpc_java.html" title="Java RPC"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="remote_io.html" title="AJAX"
             accesskey="P">previous</a> |</li>
				<li> &raquo; <a href="http://qooxdoo.org">Home</a> &raquo;</li>
        <li><a href="../../index.html">qooxdoo v1.3 documentation</a> &raquo;</li>
          <li><a href="../communication.html" accesskey="U">Communication</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="rpc-remote-procedure-call">
<span id="pages-rpc-rpc-remote-procedure-call"></span><h1>RPC (Remote Procedure Call)<a class="headerlink" href="#rpc-remote-procedure-call" title="Permalink to this headline">¶</a></h1>
<p><strong>qooxdoo includes an advanced RPC mechanism for direct calls to server-side methods. It allows you to write true client/server applications without having to worry about the communication details.</strong></p>
<p>The qooxdoo RPC is based on <a class="reference external" href="http://json-rpc.org/">JSON-RPC</a> as the serialization and method call protocol, and qooxdoo provides server backends for Java, PHP, and Perl projects. A Python backend library is also provided by a third party. All parameters and return values are automatically converted between JavaScript and the server-side language.</p>
<div class="section" id="setup">
<span id="pages-rpc-setup"></span><h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>To make use of the RPC, you need to set up a server backend first.</p>
<p>Configuration of each server backend needs slightly different treatment. Please see the page relevant to you:</p>
<ul class="simple">
<li><a class="reference internal" href="rpc_java.html"><em>Java</em></a></li>
<li><a class="reference internal" href="rpc_php.html"><em>PHP</em></a></li>
<li><a class="reference internal" href="rpc_perl.html"><em>Perl</em></a></li>
<li><a class="reference internal" href="rpc_python.html"><em>Python</em></a></li>
</ul>
<p>Your favorite language is missing? Feel free to write your own qooxdoo RPC server, consult the <a class="reference internal" href="rpc_server_writer_guide.html"><em>RPC Server Writer Guide</em></a> for details.</p>
</div>
<div class="section" id="making-remote-calls">
<span id="pages-rpc-making-remote-calls"></span><h2>Making remote calls<a class="headerlink" href="#making-remote-calls" title="Permalink to this headline">¶</a></h2>
<div class="section" id="basic-call-syntax">
<span id="pages-rpc-basic-call-syntax"></span><h3>Basic call syntax<a class="headerlink" href="#basic-call-syntax" title="Permalink to this headline">¶</a></h3>
<p>To make remote calls, you need to create an instance of the Rpc class:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">rpc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">qx</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">Rpc</span><span class="p">(</span>
    <span class="s2">&quot;http://localhost:8080/qooxdoo/.qxrpc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;qooxdoo.test&quot;</span>
<span class="p">);</span>
</pre></div>
</div>
<p>The first parameter is the URL of the backend (in this example a Java backend on localhost). The second is the name of the service you'd like to call. In Java, this is the fully qualified name of a class. (The Java backend includes the <tt class="docutils literal"><span class="pre">qooxdoo.test</span></tt> service used in the example. The class name is lowercase to keep it in sync with the PHP examples - in Java-only projects, you would of course use standard Java naming conventions.)</p>
<p>When you have the Rpc instance, you can make synchronous and asynchronous calls:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// synchronous call</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">callSync</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">);</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Result of sync call: &quot;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exc</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Exception during sync call: &quot;</span> <span class="o">+</span> <span class="nx">exc</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// asynchronous call</span>
<span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">exc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exc</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Result of async call: &quot;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Exception during async call: &quot;</span> <span class="o">+</span> <span class="nx">exc</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="nx">rpc</span><span class="p">.</span><span class="nx">callAsync</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>For synchronous calls, the first parameter is the method name. After that, one or more parameters for this method may follow (in this case, a single string). Please note that synchronous calls typically block the browser UI until the result arrives, so they should only be used sparingly (if at all)!</p>
<p>Asynchronous calls work similarly. The only difference is an additional first parameter that specifies a handler function. This function is called when the result of the method call is available or when an exception occurred.</p>
<p>You can also use qooxdoo event listeners for asynchronous calls - just use <tt class="docutils literal"><span class="pre">callAsyncListeners</span></tt> instead of <tt class="docutils literal"><span class="pre">callAsync</span></tt>. More details can be found in the <a class="reference external" href="http://api.qooxdoo.org/#qx.io.Remote.Rpc">API documentation</a>.</p>
<p>One difference between the qooxdoo RPC and other RPC implementations are client stubs. These are small wrapper classes that provide the same methods as the corresponding server classes, so they can be called like ordinary JavaScript methods. In qooxdoo, there are no such stubs by default, so you have to provide the method name as a string. The advantage is that there's no additional build step for generating stubs, and it's also not necessary to &quot;register&quot; your server classes at runtime (which would be a prerequisite for dynamic stub generation). If you really want or need client stubs, you currently have to write the stubs (or a generator for them) yourself. Future qooxdoo versions may include such a generator.</p>
</div>
<div class="section" id="parameter-and-result-conversion">
<span id="pages-rpc-parameter-and-result-conversion"></span><h3>Parameter and result conversion<a class="headerlink" href="#parameter-and-result-conversion" title="Permalink to this headline">¶</a></h3>
<p>All method parameters and result values are automatically converted to and from the backend language. Using the Java backend, you can even have overloaded methods, and the correct one will be picked based on the provided parameters.</p>
<p>The following table lists the data types supported by the Java backend and the corresponding JavaScript types:</p>
<table border="1" class="docutils">
<colgroup>
<col width="73%" />
<col width="27%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Java type</th>
<th class="head">JavaScript type</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>int, long, double, Integer, Long, Double</td>
<td>number</td>
</tr>
<tr><td>boolean, Boolean</td>
<td>boolean</td>
</tr>
<tr><td>String</td>
<td>String</td>
</tr>
<tr><td>java.util.Date</td>
<td>Date</td>
</tr>
<tr><td>Array (of any of the supported types)</td>
<td>Array</td>
</tr>
<tr><td>java.util.Map</td>
<td>Object</td>
</tr>
<tr><td>JavaBean</td>
<td>Object</td>
</tr>
</tbody>
</table>
<p>The first few cases are quite simple, but the last two need some more explanation. If a Java method expects a <tt class="docutils literal"><span class="pre">java.util.Map</span></tt>, you can send any JavaScript object to it. All properties of the object are converted to Java and become members of the Java Map. When a Map is used as a return value, it's converted to a JavaScript object in a similar way: A new object is created, and then all key/value pairs in the map are converted themselves and then added as properties to this object. (Please note that &quot;properties&quot; is used here in the native JavaScript sense, not in the sense of <a class="reference internal" href="../core/understanding_properties.html"><em>qooxdoo properties</em></a>.)</p>
<p>JavaBeans are converted in a similar way. The properties of the JavaBean become JavaScript properties and vice versa. If a JavaScript object contains properties for which no corresponding setters exist in the JavaBean, they are ignored.</p>
<p>For performance reasons, recursive conversion of JavaBeans and Maps is performed without checking for cycles! If there's a reference cycle somewhere, you end up with a StackOverflowException. The same is true when you try to send a JavaScript object to the server: If it (indirectly) references itself, you get a recursion error in the browser.</p>
<p>Besides the fully-automatic conversions, there's also a class hinting mechanism. You can use it in case you need to send a specific sub-class to the server (see below for details). However, it can't be used to instantiate classes without a default constructor yet. Future qooxdoo versions may provide more extensive class hinting support.</p>
</div>
<div class="section" id="aborting-a-call">
<span id="pages-rpc-aborting-a-call"></span><h3>Aborting a call<a class="headerlink" href="#aborting-a-call" title="Permalink to this headline">¶</a></h3>
<p>You can abort an asynchronous call while it's still being performed:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// Rpc instantiation and handler function left out for brevity</span>

<span class="kd">var</span> <span class="nx">callref</span> <span class="o">=</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">callAsync</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">);</span>

<span class="c1">// ...</span>

<span class="nx">rpc</span><span class="p">.</span><span class="nx">abort</span><span class="p">(</span><span class="nx">callref</span><span class="p">);</span>
  <span class="c1">// the handler will be called with an abort exception</span>
</pre></div>
</div>
</div>
<div class="section" id="error-handling">
<span id="pages-rpc-error-handling"></span><h3>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h3>
<p>When you make a synchronous call, you can catch an exception to handle errors. In its <tt class="docutils literal"><span class="pre">rpcdetails</span></tt> property, the exception contains an object that describes the error in more detail. The same details are also available in the second parameter in an asynchronous handler function, as well as in the events fired by <tt class="docutils literal"><span class="pre">callAsyncListeners</span></tt>.</p>
<p>The following example shows how errors can be handled:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// creation of the Rpc instance left out for brevity</span>

<span class="kd">var</span> <span class="nx">showDetails</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">details</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span>
        <span class="s2">&quot;origin: &quot;</span> <span class="o">+</span> <span class="nx">details</span><span class="p">.</span><span class="nx">origin</span> <span class="o">+</span>
        <span class="s2">&quot;; code: &quot;</span> <span class="o">+</span> <span class="nx">details</span><span class="p">.</span><span class="nx">code</span> <span class="o">+</span>
        <span class="s2">&quot;; message: &quot;</span> <span class="o">+</span> <span class="nx">details</span><span class="p">.</span><span class="nx">message</span>
    <span class="p">);</span>
<span class="p">};</span>

<span class="c1">// error handling for sync calls</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">callSync</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exc</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">showDetails</span><span class="p">(</span><span class="nx">exc</span><span class="p">.</span><span class="nx">rpcdetails</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// error handling for async calls</span>
<span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">exc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exc</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">showDetails</span><span class="p">(</span><span class="nx">exc</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="nx">rpc</span><span class="p">.</span><span class="nx">callAsync</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The following <tt class="docutils literal"><span class="pre">origin</span></tt>'s are defined:</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="82%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Constant</th>
<th class="head">Meaning</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>qx.io.remote.Rpc.origin.server</td>
<td>The error occurred on the server (e.g. when a non-existing method is called).</td>
</tr>
<tr><td>qx.io.remote.Rpc.origin.application</td>
<td>The error occurred inside the server application (i.e. during a method call in non-qooxdoo code).</td>
</tr>
<tr><td>qx.io.remote.Rpc.origin.transport</td>
<td>The error occurred in the communication layer (e.g. when the Rpc instance was constructed with an URL where no backend is deployed, resulting in an HTTP 404 error).</td>
</tr>
<tr><td>qx.io.remote.Rpc.origin.local</td>
<td>The error occurred locally (when the call timed out or when it was aborted).</td>
</tr>
</tbody>
</table>
<p>The <tt class="docutils literal"><span class="pre">code</span></tt> depends on the origin. For the server and application origins, the possible codes are defined by the backend implementation. For transport errors, it's the HTTP status code. For local errors, the following codes are defined:</p>
<table border="1" class="docutils">
<colgroup>
<col width="63%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Constant</th>
<th class="head">Meaning</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>qx.io.remote.Rpc.localError.timeout</td>
<td>A timeout occurred.</td>
</tr>
<tr><td>qx.io.remote.Rpc.localError.abort</td>
<td>The call was aborted.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="cross-domain-calls">
<span id="pages-rpc-cross-domain-calls"></span><h3>Cross-domain calls<a class="headerlink" href="#cross-domain-calls" title="Permalink to this headline">¶</a></h3>
<p>Using the qooxdoo RPC implementation, you can also make calls across domain boundaries. On the client side, all you have to do is specify the correct destination URL in the Rpc constructor and set the crossDomain property to <tt class="docutils literal"><span class="pre">true</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">rpc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">qx</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">Rpc</span><span class="p">(</span><span class="s2">&quot;http://targetdomain.com/appname/.qxrpc&quot;</span><span class="p">);</span>
<span class="nx">rpc</span><span class="p">.</span><span class="nx">setCrossDomain</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</pre></div>
</div>
<p>On the server side, you need to configure the backend to accept cross-domain calls (see the documentation comments in the various backend implementations).</p>
</div>
</div>
<div class="section" id="writing-your-own-services">
<span id="pages-rpc-writing-your-own-services"></span><h2>Writing your own services<a class="headerlink" href="#writing-your-own-services" title="Permalink to this headline">¶</a></h2>
<div class="section" id="java">
<span id="pages-rpc-java"></span><h3>Java<a class="headerlink" href="#java" title="Permalink to this headline">¶</a></h3>
<p>Writing your own remotely callable methods is very easy. Just create a class like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kr">package</span> <span class="nx">my</span><span class="p">.</span><span class="kr">package</span><span class="p">;</span>

<span class="kr">import</span> <span class="nx">net</span><span class="p">.</span><span class="nx">sf</span><span class="p">.</span><span class="nx">qooxdoo</span><span class="p">.</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">RemoteService</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">net</span><span class="p">.</span><span class="nx">sf</span><span class="p">.</span><span class="nx">qooxdoo</span><span class="p">.</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">RemoteServiceException</span><span class="p">;</span>

<span class="kr">public</span> <span class="kr">class</span> <span class="nx">MyService</span> <span class="kr">implements</span> <span class="nx">RemoteService</span> <span class="p">{</span>

    <span class="kr">public</span> <span class="kr">int</span> <span class="nx">add</span><span class="p">(</span><span class="kr">int</span> <span class="nx">a</span><span class="p">,</span> <span class="kr">int</span> <span class="nx">b</span><span class="p">)</span> <span class="kr">throws</span> <span class="nx">RemoteServiceException</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>All you need to do is include this class in your webapp (together with the qooxdoo backend classes), and it will be available for calls from JavaScript! You don't need to write or modify any configuration files, and you don't need to register this class anywhere. The only requirements are:</p>
<ol class="arabic simple">
<li>The class has to implement the <tt class="docutils literal"><span class="pre">RemoteService</span></tt> interface. This is a so-called tagging interface, i.e. it has no methods.</li>
<li>All methods that should be remotely available must be declared to throw a <tt class="docutils literal"><span class="pre">RemoteServiceException</span></tt>.</li>
</ol>
<p>Both requirements are there to protect arbitrary Java code from being called.</p>
<div class="section" id="accessing-the-session">
<span id="pages-rpc-accessing-the-session"></span><h4>Accessing the session<a class="headerlink" href="#accessing-the-session" title="Permalink to this headline">¶</a></h4>
<p>There is one instance of a service class per session. To get access to the current session, you can provide an <em>injection</em> method called <tt class="docutils literal"><span class="pre">setQooxdooEnvironment</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kr">package</span> <span class="nx">my</span><span class="p">.</span><span class="kr">package</span><span class="p">;</span>

<span class="kr">import</span> <span class="nx">javax</span><span class="p">.</span><span class="nx">servlet</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">HttpSession</span><span class="p">;</span>

<span class="kr">import</span> <span class="nx">net</span><span class="p">.</span><span class="nx">sf</span><span class="p">.</span><span class="nx">qooxdoo</span><span class="p">.</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">Environment</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">net</span><span class="p">.</span><span class="nx">sf</span><span class="p">.</span><span class="nx">qooxdoo</span><span class="p">.</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">RemoteService</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">net</span><span class="p">.</span><span class="nx">sf</span><span class="p">.</span><span class="nx">qooxdoo</span><span class="p">.</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">RemoteServiceException</span><span class="p">;</span>

<span class="kr">public</span> <span class="kr">class</span> <span class="nx">MyService</span> <span class="kr">implements</span> <span class="nx">RemoteService</span> <span class="p">{</span>

    <span class="kr">private</span> <span class="nx">Environment</span> <span class="nx">_env</span><span class="p">;</span>

    <span class="kr">public</span> <span class="k">void</span> <span class="nx">setQooxdooEnvironment</span><span class="p">(</span><span class="nx">Environment</span> <span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_env</span> <span class="o">=</span> <span class="nx">env</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kr">public</span> <span class="k">void</span> <span class="nx">someRemoteMethod</span><span class="p">()</span> <span class="kr">throws</span> <span class="nx">RemoteServiceException</span> <span class="p">{</span>
        <span class="nx">HttpSession</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">_env</span><span class="p">.</span><span class="nx">getRequest</span><span class="p">().</span><span class="nx">getSession</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>The environment provides access to the current request (via <tt class="docutils literal"><span class="pre">getRequest</span></tt>) and the RpcServlet instance that is handling the current call (via <tt class="docutils literal"><span class="pre">getRpcServlet</span></tt>).</p>
</div>
</div>
</div>
<div class="section" id="advanced-java-topics">
<span id="pages-rpc-advanced-java-topics"></span><h2>Advanced Java topics<a class="headerlink" href="#advanced-java-topics" title="Permalink to this headline">¶</a></h2>
<div class="section" id="automatic-client-configuration">
<span id="pages-rpc-automatic-client-configuration"></span><h3>Automatic client configuration<a class="headerlink" href="#automatic-client-configuration" title="Permalink to this headline">¶</a></h3>
<p>The Java RPC backend contains an auto-config mechanism, mainly used for automatically detecting the server URL. You can access it by including the following script tag in your HTML page:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="c">&lt;!-- ... --&gt;</span>
        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;.qxrpc&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>Provided the HTML page is part of the webapp (and not loaded via <a class="reference external" href="file:*">file:*</a>...), and provided that you didn't change the default mapping of the RpcServlet (<tt class="docutils literal"><span class="pre">.qxrpc</span></tt>), any request to <tt class="docutils literal"><span class="pre">http://server/app/foo/bar.qxrpc</span></tt> (or anything else that ends with .qxrpc) will always be directed to the RpcServlet. The RpcServlet fills a structure with basic information about the server. It may answer with something like</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">qx</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">ServerSettings</span> <span class="o">=</span> <span class="p">{</span><span class="nx">serverPathPrefix</span><span class="o">:</span> <span class="s1">&#39;http://server/app&#39;</span><span class="p">,</span> <span class="p">...}</span>
</pre></div>
</div>
<p>and this is used by the <tt class="docutils literal"><span class="pre">makeServerURL()</span></tt> helper method in the RPC class. You can use this when instantiating an RPC instance:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">rpc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">qx</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">Rpc</span><span class="p">(</span>
    <span class="nx">qx</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">Rpc</span><span class="p">.</span><span class="nx">makeServerURL</span><span class="p">(),</span>
    <span class="s2">&quot;my.package.MyService&quot;</span>
<span class="p">);</span>
</pre></div>
</div>
<p>This way, you don't need to hardcode the URL of the service. Your client code will work without modifications, no matter what the name of your application is or where it is deployed. By generating absolute URLs you don't have to worry about moving around web pages and scripts in the directory structure, which is a common shortcoming of relative URLs. The auto-configration feature is also convenient if you need to embed a session id into the URL.</p>
</div>
<div class="section" id="subclassing-rpcservlet">
<span id="pages-rpc-subclassing-rpcservlet"></span><h3>Subclassing RpcServlet<a class="headerlink" href="#subclassing-rpcservlet" title="Permalink to this headline">¶</a></h3>
<p>It can be useful to create your own version of qooxdoo's <tt class="docutils literal"><span class="pre">RpcServlet</span></tt>. Some of the benefits of subclassing it are:</p>
<ol class="arabic simple">
<li><strong>Custom object conversion</strong>: By creating your own subclass, you can provide code for custom conversion of objects. This is especially useful for classes that don't have a default constructor.</li>
<li><strong>Detailed server logging</strong>: You can hook your own code into the method calling mechanism, e.g. to provide detailed failure logging (the JavaScript side only receives rather generic errors).</li>
<li><strong>Property filtering</strong>: For methods that return JavaBeans, you can filter the properties that should be sent to the client. This can save a lot of bandwidth without having to completely wrap the result in a custom object.</li>
<li><strong>Class hinting</strong>: For security reasons, the class hinting mechanism isn't active by default (otherwise, client code could instantiate arbitrary server classes). By overriding a method, you can enable it on a case-by-case basis.</li>
</ol>
<p>The following example code shows how all of this can be done:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kr">package</span> <span class="nx">my</span><span class="p">.</span><span class="kr">package</span><span class="p">;</span>

<span class="kr">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">InvocationTargetException</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">Calendar</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">Map</span><span class="p">;</span>

<span class="kr">import</span> <span class="nx">net</span><span class="p">.</span><span class="nx">sf</span><span class="p">.</span><span class="nx">qooxdoo</span><span class="p">.</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">RpcServlet</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">net</span><span class="p">.</span><span class="nx">sf</span><span class="p">.</span><span class="nx">qooxdoo</span><span class="p">.</span><span class="nx">rpc</span><span class="p">.</span><span class="nx">RemoteCallUtils</span><span class="p">;</span>

<span class="kr">import</span> <span class="nx">org</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">JSONArray</span><span class="p">;</span>

<span class="kr">public</span> <span class="kr">class</span> <span class="nx">MyRpcServlet</span> <span class="kr">extends</span> <span class="nx">RpcServlet</span> <span class="p">{</span>

    <span class="kr">protected</span> <span class="nx">RemoteCallUtils</span> <span class="nx">getRemoteCallUtils</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">RemoteCallUtils</span><span class="p">()</span> <span class="p">{</span>

            <span class="c1">// log exceptions by overriding callCompatibleMethod</span>

            <span class="kr">protected</span> <span class="nb">Object</span> <span class="nx">callCompatibleMethod</span><span class="p">(</span><span class="nb">Object</span> <span class="nx">instance</span><span class="p">,</span>
                    <span class="nb">String</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">JSONArray</span> <span class="nx">parameters</span><span class="p">)</span>
                    <span class="kr">throws</span> <span class="nx">Exception</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">callCompatibleMethod</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">parameters</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">exc</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">exc</span><span class="p">.</span><span class="nx">printStackTrace</span><span class="p">();</span>
                    <span class="k">throw</span> <span class="nx">exc</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">// influence object conversion</span>

            <span class="kr">public</span> <span class="nb">Object</span> <span class="nx">toJava</span><span class="p">(</span><span class="nb">Object</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">Class</span> <span class="nx">targetType</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// insert custom conversion to Java here</span>
                <span class="c1">// (default: call super method)</span>
                <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">toJava</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">targetType</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="kr">public</span> <span class="nb">Object</span> <span class="nx">fromJava</span><span class="p">(</span><span class="nb">Object</span> <span class="nx">obj</span><span class="p">)</span>
                <span class="kr">throws</span> <span class="nx">IllegalAccessException</span><span class="p">,</span> <span class="nx">InvocationTargetException</span><span class="p">,</span>
                <span class="nx">NoSuchMethodException</span> <span class="p">{</span>

                <span class="c1">// use Dates instead of Calendars (so that the</span>
                <span class="c1">// client code receives native JavaScript dates)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Calendar</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">fromJava</span><span class="p">(((</span><span class="nx">Calendar</span><span class="p">)</span> <span class="nx">obj</span><span class="p">).</span><span class="nx">getTime</span><span class="p">());</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">fromJava</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// filter unwanted bean properties</span>

            <span class="kr">protected</span> <span class="nx">Map</span> <span class="nx">filter</span><span class="p">(</span><span class="nb">Object</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">Map</span> <span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">Date</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">map</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;timezoneOffset&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">map</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// class hinting</span>

            <span class="kr">protected</span> <span class="nx">Class</span> <span class="nx">resolveClassHint</span><span class="p">(</span><span class="nb">String</span> <span class="nx">requestedTypeName</span><span class="p">,</span>
                    <span class="nx">Class</span> <span class="nx">targetType</span><span class="p">)</span> <span class="kr">throws</span> <span class="nx">Exception</span> <span class="p">{</span>
                <span class="c1">// allow class hinting in some cases</span>
                <span class="c1">// (useful for methods that expect a superclass</span>
                <span class="c1">// of SubClassA and SubClassB)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">requestedTypeName</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="s2">&quot;my.package.SubClassA&quot;</span><span class="p">)</span> <span class="o">||</span>
                    <span class="nx">requestedTypeName</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="s2">&quot;my.package.SubClassB&quot;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">forName</span><span class="p">(</span><span class="nx">requestedTypeName</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">resolveClassHint</span><span class="p">(</span><span class="nx">requestedTypeName</span><span class="p">,</span> <span class="nx">targetType</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To make use of class hinting on the client side, you have to send objects with a <tt class="docutils literal"><span class="pre">class</span></tt> attribute:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">rpc</span><span class="p">.</span><span class="nx">callAsync</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="s2">&quot;testMethod&quot;</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="o">:</span> <span class="s2">&quot;my.package.SubClassA&quot;</span><span class="p">,</span>
     <span class="nx">property1</span><span class="o">:</span> <span class="mi">123</span><span class="p">,</span>
     <span class="nx">property2</span><span class="o">:</span> <span class="mi">456</span><span class="p">,</span>
     <span class="cm">/* ... */</span>
    <span class="p">});</span>
</pre></div>
</div>
<p>Please note that <tt class="docutils literal"><span class="pre">class</span></tt> is a reserved word in JavaScript, so you have to enclose it in quotes.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="../../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">RPC (Remote Procedure Call)</a><ul>
<li><a class="reference internal" href="#setup">Setup</a></li>
<li><a class="reference internal" href="#making-remote-calls">Making remote calls</a><ul>
<li><a class="reference internal" href="#basic-call-syntax">Basic call syntax</a></li>
<li><a class="reference internal" href="#parameter-and-result-conversion">Parameter and result conversion</a></li>
<li><a class="reference internal" href="#aborting-a-call">Aborting a call</a></li>
<li><a class="reference internal" href="#error-handling">Error handling</a></li>
<li><a class="reference internal" href="#cross-domain-calls">Cross-domain calls</a></li>
</ul>
</li>
<li><a class="reference internal" href="#writing-your-own-services">Writing your own services</a><ul>
<li><a class="reference internal" href="#java">Java</a><ul>
<li><a class="reference internal" href="#accessing-the-session">Accessing the session</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-java-topics">Advanced Java topics</a><ul>
<li><a class="reference internal" href="#automatic-client-configuration">Automatic client configuration</a></li>
<li><a class="reference internal" href="#subclassing-rpcservlet">Subclassing RpcServlet</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="remote_io.html"
                                  title="previous chapter">AJAX</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="rpc_java.html"
                                  title="next chapter">Java RPC</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../../_sources/pages/communication/rpc.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy; Copyright 2010, qooxdoo developers.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0b2.
    </div>
  </body>
</html>