var SlimeyEditor=function(a){this.slimey=a;this.current=null;this.selected=null;this.container=document.createElement("div");this.container.id="Edcontainer";this.undoStack=new SlimeyStack();this.redoStack=new SlimeyStack();this.events=new Array();this.events.selectionChange=new Array();this.events.actionPerformed=new Array();this.contentEditor=document.createElement("textarea");this.contentEditor.slimey=this.slimey;this.contentEditor.id="contentEditor";this.contentEditor.style.position="absolute";this.contentEditor.style.zIndex="20000";this.contentEditor.style.overflow="visible";this.contentEditor.style.visibility="hidden";this.contentEditor.style.top=-1000;this.contentEditor.style.backgroundColor="#FFFFEE";this.contentEditor.systemElement=true;this.container.appendChild(this.contentEditor);this.resizeHandle=document.createElement("div");this.resizeHandle.slimey=this.slimey;this.resizeHandle.className="resizeHandle";this.resizeHandle.style.zIndex=100000000;this.resizeHandle.style.position="absolute";this.resizeHandle.style.visibility="hidden";this.resizeHandle.systemElement=true;this.container.appendChild(this.resizeHandle);this.container.className="slimeyEditor";this.container.slimey=this.slimey;this.container.style.width="100%";this.container.style.height="100%";this.container.style.position="relative";this.container.style.padding="0px";this.container.style.overflow="hidden";this.container.style.fontSize="25px";this.container.style.cursor="default";this.container.style.width="640px";this.container.style.height="480px";this.container.style.fontSize="20px";setEventHandler(this.container,"mousemove",slimeyMove);setEventHandler(this.container,"mouseup",slimeyDrop);setEventHandler(this.container,"click",slimeyDeselect);setEventHandler(this.container,"resize",this.resized,this);addEventHandler(window,"resize",this.resized,this);addEventHandler(window,"load",this.resized,this);setEventHandler(this.resizeHandle,"mousedown",slimeyDrag);setEventHandler(this.contentEditor,"blur",function(){var c=this.value;if(this.editElement.tagName=="UL"||this.editElement.tagName=="OL"){c="<li>"+c+"</li>";c=c.replace(/\n/g,"</li><li>")}else{if(this.editElement.tagName=="DIV"){c=c.replace(/\n/g,"<br>")}}var b=new SlimeyEditContentAction(this.slimey,c,this.editElement);this.slimey.editor.performAction(b);this.style.visibility="hidden";this.style.top=-1000;this.editElement=null});setEventHandler(this.contentEditor,"keyup",function(b){if(!b){var b=window.event}if(b.keyCode==27){this.onblur()}});setEventHandler(this.contentEditor,"click",function(b){if(!b){b=window.event}stopPropagation(b);return false})};SlimeyEditor.prototype.getContainer=function(){return this.container};SlimeyEditor.prototype.getHTML=function(){if(this.selected){this.selected.className="slimeyElement"}var a="";for(var b=this.container.firstChild;b;b=b.nextSibling){if(b.nodeType==1&&!b.systemElement){a+="<"+b.tagName.toLowerCase();if(b.src){a+=' src="'+b.src+'"'}a+=' style="'+b.style.cssText+'"';a+=">\n";if(b.innerHTML){a+=b.innerHTML+"\n"}a+="</"+b.tagName.toLowerCase()+">\n"}}if(this.selected){this.selected.className="slimeySelectedElement"}return a};SlimeyEditor.prototype.setHTML=function(a){this.deselect();this.container.innerHTML=a;for(var b=this.container.firstChild;b;b=b.nextSibling){if(b.nodeType==1){b.slimey=this.slimey;setEventHandler(b,"mousedown",slimeyDrag);setEventHandler(b,"click",slimeyClick);setEventHandler(b,"mouseover",slimeyHighlight);setEventHandler(b,"mouseout",slimeyLowshadow);setEventHandler(b,"dblclick",slimeyEdit);if(b.tagName=="IMG"){b.resizable=true;b.title=lang("drag the bottom right corner to resize")}else{b.editable=true;b.resizable=true;b.title=lang("double click to edit content")}b.className="slimeyElement";if(!b.style.zIndex){b.style.zIndex=10000}b.style.cursor="move"}}this.container.appendChild(this.resizeHandle);this.container.appendChild(this.contentEditor)};SlimeyEditor.prototype.getDOM=function(a){for(var b=0;b<this.container.childNodes.length;b++){var c=this.container.childNodes.item(b);if(!c.systemElement){this.container.removeChild(c);b--;a.appendChild(c)}}return a};SlimeyEditor.prototype.setDOM=function(a){this.deselect();for(var b=0;b<this.container.childNodes.length;b++){var c=this.container.childNodes.item(b);if(!c.systemElement){this.container.removeChild(c);b--}}for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes.item(b);a.removeChild(c);b--;this.container.appendChild(c)}};SlimeyEditor.prototype.getSelected=function(){return this.selected};SlimeyEditor.prototype.select=function(a){if(this.selected){this.deselect()}this.selected=a;a.className="slimeySelectedElement";this.fireEvent("selectionChange");if(a.resizable){this.resizeHandle.style.visibility="visible";this.resizeHandle.style.left=(getPercentValue(a.style.left)+getPercentValue(a.style.width))+"%";this.resizeHandle.style.top=(getPercentValue(a.style.top)+getPercentValue(a.style.height))+"%"}};SlimeyEditor.prototype.deselect=function(){if(this.selected){this.selected.className="slimeyElement"}this.selected=null;this.resizeHandle.style.visibility="hidden";this.fireEvent("selectionChange")};SlimeyEditor.prototype.performAction=function(a){a.perform();this.undoStack.push(a);this.redoStack.clear();this.fireEvent("actionPerformed")};SlimeyEditor.prototype.undo=function(){var a=this.undoStack.pop();if(a){a.undo();this.redoStack.push(a)}this.fireEvent("actionPerformed")};SlimeyEditor.prototype.redo=function(){var a=this.redoStack.pop();if(a){a.perform();this.undoStack.push(a)}this.fireEvent("actionPerformed")};SlimeyEditor.prototype.addEventListener=function(c,d,b){var a=this.events[c];a[a.length]={callback:d,scope:b}};SlimeyEditor.prototype.removeEventListener=function(b,c){var a=this.events[b];for(i=0;i<a.length;i++){if(a[i]==c){if(a.length>1){a[i]=a[a.length]}a.length--}}};SlimeyEditor.prototype.fireEvent=function(b){var a=this.events[b];for(i=0;i<a.length;i++){a[i].callback.call(a[i].scope)}};SlimeyEditor.prototype.click=function(b,a){if(b!=this.selected){this.select(b)}};SlimeyEditor.prototype.dblclick=function(b,a){if(b!=this.selected){this.select(b)}if(!b.editable){return}this.contentEditor.editElement=b;this.contentEditor.style.visibility="visible";this.contentEditor.style.fontFamily=b.style.fontFamily;this.contentEditor.style.color=b.style.color;this.contentEditor.style.fontSize=b.style.fontSize;this.contentEditor.style.fontWeight=b.style.fontWeight;this.contentEditor.style.fontStyle=b.style.fontStyle;this.contentEditor.style.textDecoration=b.style.textDecoration;this.contentEditor.style.left=b.style.left;this.contentEditor.style.top=b.style.top;this.contentEditor.style.width=b.style.width;this.contentEditor.style.height=b.style.height;var c=b.innerHTML;if(b.tagName=="UL"||b.tagName=="OL"){c=c.replace(/<\/li><li>/gi,"\n");c=c.replace(/<li>|<\/li>/gi,"")}else{if(b.tagName=="DIV"){c=c.replace(/<br>/gi,"\n")}}this.contentEditor.value=c;this.contentEditor.focus()};SlimeyEditor.prototype.drag=function(g,f){this.current=g;if(!g.systemElement){this.select(g)}var j=getMousePosition(f,this.container);this.hSize=this.container.offsetWidth;this.vSize=this.container.offsetHeight;var d=getPercentValue(g.style.left);var b=getPercentValue(g.style.top);if(d>100){d=50}if(b>100){b=50}var a=Math.round(d*this.hSize/100);var c=Math.round(b*this.vSize/100);this.difx=j.x-a;this.dify=j.y-c;this.dragx=this.movex=d;this.dragy=this.movey=b};SlimeyEditor.prototype.move=function(a){if(this.current){var b=getMousePosition(a,this.container);this.movex=Math.round((b.x-this.difx)*100/this.hSize);this.movey=Math.round((b.y-this.dify)*100/this.vSize);this.current.style.left=this.movex+"%";this.current.style.top=this.movey+"%";this.printDebug("("+this.current.style.left+", "+this.current.style.top+")");if(this.current.resizable){this.resizeHandle.style.left=(getPercentValue(this.current.style.left)+getPercentValue(this.current.style.width))+"%";this.resizeHandle.style.top=(getPercentValue(this.current.style.top)+getPercentValue(this.current.style.height))+"%"}}if(this.current==this.resizeHandle){this.selected.style.width=(getPercentValue(this.resizeHandle.style.left)-getPercentValue(this.selected.style.left))+"%";this.selected.style.height=(getPercentValue(this.resizeHandle.style.top)-getPercentValue(this.selected.style.top))+"%"}};SlimeyEditor.prototype.drop=function(){if(this.current){if(!this.current.systemElement){if(this.current.style.position=="absolute"&&(this.dragx!=this.movex||this.dragy!=this.movey)){var d=new SlimeyMoveAction(this.slimey,this.movex+"%",this.movey+"%",this.dragx+"%",this.dragy+"%");this.performAction(d)}}else{var a=(getPercentValue(this.resizeHandle.style.left)-getPercentValue(this.selected.style.left))+"%";var c=(getPercentValue(this.resizeHandle.style.top)-getPercentValue(this.selected.style.top))+"%";var e=(this.dragx-getPercentValue(this.selected.style.left))+"%";var b=(this.dragy-getPercentValue(this.selected.style.top))+"%";if(a!=e||c!=b){var d=new SlimeyResizeAction(this.slimey,a,c,e,b);this.performAction(d);if(this.contentEditor.editElement){this.contentEditor.style.width=a;this.contentEditor.style.height=c}}}}this.current=null};SlimeyEditor.prototype.resized=function(){var a=this.container.offsetHeight;this.container.style.fontSize=(a/24)+"px"};SlimeyEditor.prototype.printDebug=function(a){};function slimeyClick(a){this.slimey.editor.click(this);stopPropagation(a);return false}function slimeyHighlight(){this.className="slimeyHighlightedElement"}function slimeyLowshadow(){if(this==this.slimey.editor.getSelected()){this.className="slimeySelectedElement"}else{this.className="slimeyElement"}}function slimeyDrag(a){if(!a){var a=window.event}this.slimey.editor.drag(this,a);stopPropagation(a);return false}function slimeyMove(a){if(!a){var a=window.event}try{this.slimey.editor.move(a);stopPropagation(a)}catch(a){}return false}function slimeyDrop(a){this.slimey.editor.drop()}function slimeyDeselect(a){try{this.slimey.editor.deselect()}catch(a){}}function slimeyEdit(a){this.slimey.editor.dblclick(this,a);stopPropagation(a);return false};