(function(){function k(b,f,e){for(b=b.createTreeWalker(f,NodeFilter.SHOW_ALL,null,false);f=b.nextNode();){if(e)if(!e(f))return false;if(f.nodeType==3&&f.nodeValue&&/[^\s\u00a0]+/.test(f.nodeValue))return false;if(f.nodeType==1&&/^(HR|IMG|TABLE)$/.test(f.nodeName))return false}return true}var l=tinymce.dom.Event,o=tinymce.grep,m=tinymce.each,p=tinymce.inArray;tinymce.create("tinymce.plugins.Safari",{init:function(b){var f=this,e;if(tinymce.isWebKit){f.editor=b;f.webKitFontSizes=["x-small","small",
"medium","large","x-large","xx-large","-webkit-xxx-large"];f.namedFontSizes=["xx-small","x-small","small","medium","large","x-large","xx-large"];b.addCommand("CreateLink",function(c,d){c=b.selection.getNode();var a=b.dom;if(c&&(/^(left|right)$/i.test(a.getStyle(c,"float",1))||/^(left|right)$/i.test(a.getAttrib(c,"align")))){d=a.create("a",{href:d},c.cloneNode());c.parentNode.replaceChild(d,c);b.selection.select(d)}else b.getDoc().execCommand("CreateLink",false,d)});b.onKeyUp.add(function(c,d){var a,
g;if(d.keyCode==46||d.keyCode==8){g=c.getBody();a=g.innerHTML;d=c.selection;if(g.childNodes.length==1&&!/<(img|hr)/.test(a)&&tinymce.trim(a.replace(/<[^>]+>/g,"")).length==0){c.setContent('<p><br mce_bogus="1" /></p>',{format:"raw"});a=g.firstChild;c=d.getRng();c.setStart(a,0);c.setEnd(a,0);d.setRng(c)}}});b.addCommand("FormatBlock",function(c,d){c=b.dom;var a=c.getParent(b.selection.getNode(),c.isBlock);a?c.replace(c.create(d),a,1):b.getDoc().execCommand("FormatBlock",false,d)});b.addCommand("mceInsertContent",
function(c,d){b.getDoc().execCommand("InsertText",false,"mce_marker");b.getBody().innerHTML=b.getBody().innerHTML.replace(/mce_marker/g,b.dom.processHTML(d)+'<span id="_mce_tmp">XX</span>');b.selection.select(b.dom.get("_mce_tmp"));b.getDoc().execCommand("Delete",false," ")});b.onKeyPress.add(function(c,d){var a,g,h,i,j,n;if(d.keyCode==13){n=c.selection;a=n.getNode();if(d.shiftKey||c.settings.force_br_newlines&&a.nodeName!="LI"){f._insertBR(c);l.cancel(d)}if(g=e.getParent(a,"LI")){h=e.getParent(g,
"OL,UL");c=c.getDoc();a=e.create("p");e.add(a,"br",{mce_bogus:"1"});if(k(c,g))if(!e.getParent(h.parentNode,"LI,OL,UL")){h=e.getParent(h,"p,h1,h2,h3,h4,h5,h6,div")||h;i=c.createRange();i.setStartBefore(h);i.setEndBefore(g);j=c.createRange();j.setStartAfter(g);j.setEndAfter(h);g=i.cloneContents();j=j.cloneContents();k(c,j)||e.insertAfter(j,h);e.insertAfter(a,h);k(c,g)||e.insertAfter(g,h);e.remove(h);h=a.firstChild;i=c.createRange();i.setStartBefore(h);i.setEndBefore(h);n.setRng(i);return l.cancel(d)}}}});
b.onExecCommand.add(function(c,d){var a,g;if(d=="InsertUnorderedList"||d=="InsertOrderedList"){d=c.selection;c=c.dom;if(a=c.getParent(d.getNode(),function(h){return/^(H[1-6]|P|ADDRESS|PRE)$/.test(h.nodeName)})){g=d.getBookmark();c.remove(a,1);d.moveToBookmark(g)}}});b.onClick.add(function(c,d){d=d.target;if(d.nodeName=="IMG"){f.selElm=d;c.selection.select(d)}else f.selElm=null});b.onInit.add(function(){f._fixWebKitSpans()});b.onSetContent.add(function(){e=b.dom;m(["strong","b","em","u","strike","sub",
"sup","a"],function(c){m(o(e.select(c)).reverse(),function(d){var a=d.nodeName.toLowerCase(),g;if(a=="a")d.name&&e.replace(e.create("img",{mce_name:"a",name:d.name,"class":"mceItemAnchor"}),d);else{switch(a){case "b":case "strong":if(a=="b")a="strong";g="font-weight: bold;";break;case "em":g="font-style: italic;";break;case "u":g="text-decoration: underline;";break;case "sub":g="vertical-align: sub;";break;case "sup":g="vertical-align: super;";break;case "strike":g="text-decoration: line-through;";
break}e.replace(e.create("span",{mce_name:a,style:g,"class":"Apple-style-span"}),d,1)}})})});b.onPreProcess.add(function(c,d){e=c.dom;m(o(d.node.getElementsByTagName("span")).reverse(),function(a){var g;if(d.get)if(e.hasClass(a,"Apple-style-span")){g=a.style.backgroundColor;switch(e.getAttrib(a,"mce_name")){case "font":c.settings.convert_fonts_to_spans||e.setAttrib(a,"style","");break;case "strong":case "em":case "sub":case "sup":e.setAttrib(a,"style","");break;case "strike":case "u":c.settings.inline_styles?
e.setAttrib(a,"mce_name",""):e.setAttrib(a,"style","");break;default:c.settings.inline_styles||e.setAttrib(a,"style","")}if(g)a.style.backgroundColor=g}e.hasClass(a,"mceItemRemoved")&&e.remove(a,1)})});b.onPostProcess.add(function(c,d){d.content=d.content.replace(/<br \/><\/(h[1-6]|div|p|address|pre)>/g,"</$1>");d.content=d.content.replace(/ id=\"undefined\"/g,"")})}},getInfo:function(){return{longname:"Safari compatibility",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/safari",
version:tinymce.majorVersion+"."+tinymce.minorVersion}},_fixWebKitSpans:function(){var b=this;l.add(b.editor.getDoc(),"DOMNodeInserted",function(f){(f=f.target)&&f.nodeType==1&&b._fixAppleSpan(f)})},_fixAppleSpan:function(b){var f=this.editor,e=f.dom,c=this.webKitFontSizes,d=this.namedFontSizes;f=f.settings;var a;if(!e.getAttrib(b,"mce_fixed"))if(b.nodeName=="SPAN"&&b.className=="Apple-style-span"){a=b.style;if(f.convert_fonts_to_spans)a.fontSize&&e.setStyle(b,"fontSize",d[p(c,a.fontSize)]);else{if(a.fontSize){e.setAttrib(b,
"mce_name","font");e.setAttrib(b,"size",p(c,a.fontSize)+1)}if(a.fontFamily){e.setAttrib(b,"mce_name","font");e.setAttrib(b,"face",a.fontFamily)}if(a.color){e.setAttrib(b,"mce_name","font");e.setAttrib(b,"color",e.toHex(a.color))}if(a.backgroundColor){e.setAttrib(b,"mce_name","font");e.setStyle(b,"background-color",a.backgroundColor)}}a.fontWeight=="bold"&&e.setAttrib(b,"mce_name","strong");a.fontStyle=="italic"&&e.setAttrib(b,"mce_name","em");a.textDecoration=="underline"&&e.setAttrib(b,"mce_name",
"u");a.textDecoration=="line-through"&&e.setAttrib(b,"mce_name","strike");a.verticalAlign=="super"&&e.setAttrib(b,"mce_name","sup");a.verticalAlign=="sub"&&e.setAttrib(b,"mce_name","sub");e.setAttrib(b,"mce_fixed","1")}},_insertBR:function(b){var f=b.dom,e=b.selection,c=e.getRng(),d;c.insertNode(d=f.create("br"));c.setStartAfter(d);c.setEndAfter(d);e.setRng(c);if(e.getSel().focusNode==d.previousSibling){e.select(f.insertAfter(f.doc.createTextNode("\u00a0"),d));e.collapse(1)}b.getWin().scrollTo(0,
f.getPos(e.getRng().startContainer).y)}});tinymce.PluginManager.add("safari",tinymce.plugins.Safari)})();
