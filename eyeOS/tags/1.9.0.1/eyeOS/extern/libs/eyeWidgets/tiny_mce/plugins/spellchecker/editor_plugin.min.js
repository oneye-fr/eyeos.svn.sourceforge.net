(function(){var o=tinymce.util.JSONRequest,k=tinymce.each,p=tinymce.DOM;tinymce.create("tinymce.plugins.SpellcheckerPlugin",{getInfo:function(){return{longname:"Spellchecker",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/spellchecker",version:tinymce.majorVersion+"."+tinymce.minorVersion}},init:function(b,c){var a=this;a.url=c;a.editor=b;b.addCommand("mceSpellCheck",function(){if(a.active)a._done();else{b.setProgressState(1);
a._sendRPC("checkWords",[a.selectedLang,a._getWords()],function(d){if(d.length>0){a.active=1;a._markWords(d);b.setProgressState(0);b.nodeChanged()}else{b.setProgressState(0);b.windowManager.alert("spellchecker.no_mpell")}})}});b.onInit.add(function(){b.settings.content_css!==false&&b.dom.loadCSS(c+"/css/content.css")});b.onClick.add(a._showMenu,a);b.onContextMenu.add(a._showMenu,a);b.onBeforeGetContent.add(function(){a.active&&a._removeWords()});b.onNodeChange.add(function(d,e){e.setActive("spellchecker",
a.active)});b.onSetContent.add(function(){a._done()});b.onBeforeGetContent.add(function(){a._done()});b.onBeforeExecCommand.add(function(d,e){e=="mceFullScreen"&&a._done()});a.languages={};k(b.getParam("spellchecker_languages","+English=en,Danish=da,Dutch=nl,Finnish=fi,French=fr,German=de,Italian=it,Polish=pl,Portuguese=pt,Spanish=es,Swedish=sv","hash"),function(d,e){if(e.indexOf("+")===0){e=e.substring(1);a.selectedLang=d}a.languages[e]=d})},createControl:function(b,c){var a=this;if(b=="spellchecker"){b=
c.createSplitButton(b,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:a});b.onRenderMenu.add(function(d,e){e.add({title:"spellchecker.langs","class":"mceMenuItemTitle"}).setDisabled(1);k(a.languages,function(f,h){var i={icon:1},g;i.onclick=function(){g.setSelected(1);a.selectedItem.setSelected(0);a.selectedItem=g;a.selectedLang=f};i.title=h;g=e.add(i);g.setSelected(f==a.selectedLang);if(f==a.selectedLang)a.selectedItem=g})});return b}},_walk:function(b,c){var a=this.editor.getDoc();if(a.createTreeWalker)for(a=
a.createTreeWalker(b,NodeFilter.SHOW_TEXT,null,false);(b=a.nextNode())!=null;)c.call(this,b);else tinymce.walk(b,c,"childNodes")},_getSeparators:function(){var b="",c,a=this.editor.getParam("spellchecker_word_separator_chars",'\\s!"#$%&()*+,-./:;<=>?@[]^_{|}\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\u201d\u201c');for(c=0;c<a.length;c++)b+="\\"+a.charAt(c);return b},_getWords:function(){var b=[],c="",a={};this._walk(this.editor.getBody(),function(d){if(d.nodeType==
3)c+=d.nodeValue+" "});c=c.replace(new RegExp("([0-9]|["+this._getSeparators()+"])","g")," ");c=tinymce.trim(c.replace(/(\s+)/g," "));k(c.split(" "),function(d){if(!a[d]){b.push(d);a[d]=1}});return b},_removeWords:function(b){var c=this.editor,a=c.dom;c=c.selection;var d=c.getBookmark();k(a.select("span").reverse(),function(e){if(e&&(a.hasClass(e,"mceItemHiddenSpellWord")||a.hasClass(e,"mceItemHidden")))if(!b||a.decode(e.innerHTML)==b)a.remove(e,1)});c.moveToBookmark(d)},_markWords:function(b){var c,
a,d,e,f,h="",i=this.editor,g=this._getSeparators(),m=i.dom,n=[];i=i.selection;var q=i.getBookmark();k(b,function(l){h+=(h?"|":"")+l});c=new RegExp("(["+g+"])("+h+")(["+g+"])","g");a=new RegExp("^("+h+")","g");d=new RegExp("("+h+")(["+g+"]?)$","g");e=new RegExp("^("+h+")(["+g+"]?)$","g");f=new RegExp("("+h+")(["+g+"])","g");this._walk(this.editor.getBody(),function(l){l.nodeType==3&&n.push(l)});k(n,function(l){var j;if(l.nodeType==3){j=l.nodeValue;if(c.test(j)||a.test(j)||d.test(j)||e.test(j)){j=m.encode(j);
j=j.replace(f,'<span class="mceItemHiddenSpellWord">$1</span>$2');j=j.replace(d,'<span class="mceItemHiddenSpellWord">$1</span>$2');m.replace(m.create("span",{"class":"mceItemHidden"},j),l)}}});i.moveToBookmark(q)},_showMenu:function(b,c){var a=this;b=a.editor;var d=a._menu,e,f=b.dom,h=f.getViewPort(b.getWin());if(!d){e=p.getPos(b.getContentAreaContainer());d=b.controlManager.createDropMenu("spellcheckermenu",{offset_x:e.x,offset_y:e.y,"class":"mceNoIcons"});a._menu=d}if(f.hasClass(c.target,"mceItemHiddenSpellWord")){d.removeAll();
d.add({title:"spellchecker.wait","class":"mceMenuItemTitle"}).setDisabled(1);a._sendRPC("getSuggestions",[a.selectedLang,f.decode(c.target.innerHTML)],function(i){d.removeAll();if(i.length>0){d.add({title:"spellchecker.sug","class":"mceMenuItemTitle"}).setDisabled(1);k(i,function(g){d.add({title:g,onclick:function(){f.replace(b.getDoc().createTextNode(g),c.target);a._checkDone()}})});d.addSeparator()}else d.add({title:"spellchecker.no_sug","class":"mceMenuItemTitle"}).setDisabled(1);d.add({title:"spellchecker.ignore_word",
onclick:function(){f.remove(c.target,1);a._checkDone()}});d.add({title:"spellchecker.ignore_words",onclick:function(){a._removeWords(f.decode(c.target.innerHTML));a._checkDone()}});d.update()});b.selection.select(c.target);e=f.getPos(c.target);d.showMenu(e.x,e.y+c.target.offsetHeight-h.y);return tinymce.dom.Event.cancel(c)}else d.hideMenu()},_checkDone:function(){var b=this,c=b.editor.dom,a;k(c.select("span"),function(d){if(d&&c.hasClass(d,"mceItemHiddenSpellWord")){a=true;return false}});a||b._done()},
_done:function(){var b=this,c=b.active;if(b.active){b.active=0;b._removeWords();b._menu&&b._menu.hideMenu();c&&b.editor.nodeChanged()}},_sendRPC:function(b,c,a){var d=this,e=d.editor.getParam("spellchecker_rpc_url","{backend}");if(e=="{backend}"){d.editor.setProgressState(0);alert("Please specify: spellchecker_rpc_url")}else o.sendRPC({url:e,method:b,params:c,success:a,error:function(f,h){d.editor.setProgressState(0);d.editor.windowManager.alert(f.errstr||"Error response: "+h.responseText)}})}});
tinymce.PluginManager.add("spellchecker",tinymce.plugins.SpellcheckerPlugin)})();
