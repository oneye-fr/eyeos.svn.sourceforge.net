var a,SlimeyEditor=function(b){this.slimey=b;this.selected=this.current=null;this.container=document.createElement("div");this.container.id="Edcontainer";this.undoStack=new SlimeyStack;this.redoStack=new SlimeyStack;this.events=[];this.events.selectionChange=[];this.events.actionPerformed=[];this.contentEditor=document.createElement("textarea");this.contentEditor.slimey=this.slimey;this.contentEditor.id="contentEditor";this.contentEditor.style.position="absolute";this.contentEditor.style.zIndex="20000";
this.contentEditor.style.overflow="visible";this.contentEditor.style.visibility="hidden";this.contentEditor.style.top=-1000;this.contentEditor.style.backgroundColor="#FFFFEE";this.contentEditor.systemElement=true;this.container.appendChild(this.contentEditor);this.resizeHandle=document.createElement("div");this.resizeHandle.slimey=this.slimey;this.resizeHandle.className="resizeHandle";this.resizeHandle.style.zIndex=1E8;this.resizeHandle.style.position="absolute";this.resizeHandle.style.visibility=
"hidden";this.resizeHandle.systemElement=true;this.container.appendChild(this.resizeHandle);this.container.className="slimeyEditor";this.container.slimey=this.slimey;this.container.style.width="100%";this.container.style.height="100%";this.container.style.position="relative";this.container.style.padding="0px";this.container.style.overflow="hidden";this.container.style.fontSize="25px";this.container.style.cursor="default";this.container.style.width="640px";this.container.style.height="480px";this.container.style.fontSize=
"20px";setEventHandler(this.container,"mousemove",slimeyMove);setEventHandler(this.container,"mouseup",slimeyDrop);setEventHandler(this.container,"click",slimeyDeselect);setEventHandler(this.container,"resize",this.resized,this);addEventHandler(window,"resize",this.resized,this);addEventHandler(window,"load",this.resized,this);setEventHandler(this.resizeHandle,"mousedown",slimeyDrag);setEventHandler(this.contentEditor,"blur",function(){var c=this.value;if(this.editElement.tagName=="UL"||this.editElement.tagName==
"OL"){c="<li>"+c+"</li>";c=c.replace(/\n/g,"</li><li>")}else if(this.editElement.tagName=="DIV")c=c.replace(/\n/g,"<br>");this.slimey.editor.performAction(new SlimeyEditContentAction(this.slimey,c,this.editElement));this.style.visibility="hidden";this.style.top=-1000;this.editElement=null});setEventHandler(this.contentEditor,"keyup",function(c){if(!c)c=window.event;c.keyCode==27&&this.onblur()});setEventHandler(this.contentEditor,"click",function(c){if(!c)c=window.event;stopPropagation(c);return false})};
a=SlimeyEditor.prototype;a.getContainer=function(){return this.container};a.getHTML=function(){if(this.selected)this.selected.className="slimeyElement";for(var b="",c=this.container.firstChild;c;c=c.nextSibling)if(c.nodeType==1&&!c.systemElement){b+="<"+c.tagName.toLowerCase();if(c.src)b+=' src="'+c.src+'"';b+=' style="'+c.style.cssText+'"';b+=">\n";if(c.innerHTML)b+=c.innerHTML+"\n";b+="</"+c.tagName.toLowerCase()+">\n"}if(this.selected)this.selected.className="slimeySelectedElement";return b};
a.setHTML=function(b){this.deselect();this.container.innerHTML=b;for(b=this.container.firstChild;b;b=b.nextSibling)if(b.nodeType==1){b.slimey=this.slimey;setEventHandler(b,"mousedown",slimeyDrag);setEventHandler(b,"click",slimeyClick);setEventHandler(b,"mouseover",slimeyHighlight);setEventHandler(b,"mouseout",slimeyLowshadow);setEventHandler(b,"dblclick",slimeyEdit);if(b.tagName=="IMG"){b.resizable=true;b.title=lang("drag the bottom right corner to resize")}else{b.editable=true;b.resizable=true;b.title=
lang("double click to edit content")}b.className="slimeyElement";if(!b.style.zIndex)b.style.zIndex=1E4;b.style.cursor="move"}this.container.appendChild(this.resizeHandle);this.container.appendChild(this.contentEditor)};a.getDOM=function(b){for(var c=0;c<this.container.childNodes.length;c++){var d=this.container.childNodes.item(c);if(!d.systemElement){this.container.removeChild(d);c--;b.appendChild(d)}}return b};
a.setDOM=function(b){this.deselect();for(var c=0;c<this.container.childNodes.length;c++){var d=this.container.childNodes.item(c);if(!d.systemElement){this.container.removeChild(d);c--}}for(c=0;c<b.childNodes.length;c++){d=b.childNodes.item(c);b.removeChild(d);c--;this.container.appendChild(d)}};a.getSelected=function(){return this.selected};
a.select=function(b){this.selected&&this.deselect();this.selected=b;b.className="slimeySelectedElement";this.fireEvent("selectionChange");if(b.resizable){this.resizeHandle.style.visibility="visible";this.resizeHandle.style.left=getPercentValue(b.style.left)+getPercentValue(b.style.width)+"%";this.resizeHandle.style.top=getPercentValue(b.style.top)+getPercentValue(b.style.height)+"%"}};
a.deselect=function(){if(this.selected)this.selected.className="slimeyElement";this.selected=null;this.resizeHandle.style.visibility="hidden";this.fireEvent("selectionChange")};a.performAction=function(b){b.perform();this.undoStack.push(b);this.redoStack.clear();this.fireEvent("actionPerformed")};a.undo=function(){var b=this.undoStack.pop();if(b){b.undo();this.redoStack.push(b)}this.fireEvent("actionPerformed")};a.redo=function(){var b=this.redoStack.pop();if(b){b.perform();this.undoStack.push(b)}this.fireEvent("actionPerformed")};
a.addEventListener=function(b,c,d){b=this.events[b];b[b.length]={callback:c,scope:d}};a.removeEventListener=function(b,c){b=this.events[b];for(i=0;i<b.length;i++)if(b[i]==c){if(b.length>1)b[i]=b[b.length];b.length--}};a.fireEvent=function(b){b=this.events[b];for(i=0;i<b.length;i++)b[i].callback.call(b[i].scope)};a.click=function(b){b!=this.selected&&this.select(b)};
a.dblclick=function(b){b!=this.selected&&this.select(b);if(b.editable){this.contentEditor.editElement=b;this.contentEditor.style.visibility="visible";this.contentEditor.style.fontFamily=b.style.fontFamily;this.contentEditor.style.color=b.style.color;this.contentEditor.style.fontSize=b.style.fontSize;this.contentEditor.style.fontWeight=b.style.fontWeight;this.contentEditor.style.fontStyle=b.style.fontStyle;this.contentEditor.style.textDecoration=b.style.textDecoration;this.contentEditor.style.left=
b.style.left;this.contentEditor.style.top=b.style.top;this.contentEditor.style.width=b.style.width;this.contentEditor.style.height=b.style.height;var c=b.innerHTML;if(b.tagName=="UL"||b.tagName=="OL"){c=c.replace(/<\/li><li>/gi,"\n");c=c.replace(/<li>|<\/li>/gi,"")}else if(b.tagName=="DIV")c=c.replace(/<br>/gi,"\n");this.contentEditor.value=c;this.contentEditor.focus()}};
a.drag=function(b,c){this.current=b;b.systemElement||this.select(b);c=getMousePosition(c,this.container);this.hSize=this.container.offsetWidth;this.vSize=this.container.offsetHeight;var d=getPercentValue(b.style.left);b=getPercentValue(b.style.top);if(d>100)d=50;if(b>100)b=50;var e=Math.round(d*this.hSize/100),f=Math.round(b*this.vSize/100);this.difx=c.x-e;this.dify=c.y-f;this.dragx=this.movex=d;this.dragy=this.movey=b};
a.move=function(b){if(this.current){b=getMousePosition(b,this.container);this.movex=Math.round((b.x-this.difx)*100/this.hSize);this.movey=Math.round((b.y-this.dify)*100/this.vSize);this.current.style.left=this.movex+"%";this.current.style.top=this.movey+"%";this.printDebug("("+this.current.style.left+", "+this.current.style.top+")");if(this.current.resizable){this.resizeHandle.style.left=getPercentValue(this.current.style.left)+getPercentValue(this.current.style.width)+"%";this.resizeHandle.style.top=
getPercentValue(this.current.style.top)+getPercentValue(this.current.style.height)+"%"}}if(this.current==this.resizeHandle){this.selected.style.width=getPercentValue(this.resizeHandle.style.left)-getPercentValue(this.selected.style.left)+"%";this.selected.style.height=getPercentValue(this.resizeHandle.style.top)-getPercentValue(this.selected.style.top)+"%"}};
a.drop=function(){if(this.current)if(this.current.systemElement){var b=getPercentValue(this.resizeHandle.style.left)-getPercentValue(this.selected.style.left)+"%",c=getPercentValue(this.resizeHandle.style.top)-getPercentValue(this.selected.style.top)+"%",d=this.dragx-getPercentValue(this.selected.style.left)+"%",e=this.dragy-getPercentValue(this.selected.style.top)+"%";if(b!=d||c!=e){d=new SlimeyResizeAction(this.slimey,b,c,d,e);this.performAction(d);if(this.contentEditor.editElement){this.contentEditor.style.width=
b;this.contentEditor.style.height=c}}}else if(this.current.style.position=="absolute"&&(this.dragx!=this.movex||this.dragy!=this.movey)){d=new SlimeyMoveAction(this.slimey,this.movex+"%",this.movey+"%",this.dragx+"%",this.dragy+"%");this.performAction(d)}this.current=null};a.resized=function(){this.container.style.fontSize=this.container.offsetHeight/24+"px"};a.printDebug=function(){};function slimeyClick(b){this.slimey.editor.click(this);stopPropagation(b);return false}
function slimeyHighlight(){this.className="slimeyHighlightedElement"}function slimeyLowshadow(){this.className=this==this.slimey.editor.getSelected()?"slimeySelectedElement":"slimeyElement"}function slimeyDrag(b){if(!b)b=window.event;this.slimey.editor.drag(this,b);stopPropagation(b);return false}function slimeyMove(b){if(!b)b=window.event;try{this.slimey.editor.move(b);stopPropagation(b)}catch(c){}return false}function slimeyDrop(){this.slimey.editor.drop()}
function slimeyDeselect(){try{this.slimey.editor.deselect()}catch(b){}}function slimeyEdit(b){this.slimey.editor.dblclick(this,b);stopPropagation(b);return false};
