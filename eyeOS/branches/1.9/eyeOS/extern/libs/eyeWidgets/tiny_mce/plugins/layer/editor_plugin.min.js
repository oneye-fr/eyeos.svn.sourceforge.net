(function(){function a(a){do if(a.className&&a.className.indexOf("mceItemLayer")!=-1)return a;while(a=a.parentNode)}tinymce.create("tinymce.plugins.Layer",{init:function(b){var c=this;c.editor=b,b.addCommand("mceInsertLayer",c._insertLayer,c),b.addCommand("mceMoveForward",function(){c._move(1)}),b.addCommand("mceMoveBackward",function(){c._move(-1)}),b.addCommand("mceMakeAbsolute",function(){c._toggleAbsolute()}),b.addButton("moveforward",{title:"layer.forward_desc",cmd:"mceMoveForward"}),b.addButton("movebackward",{title:"layer.backward_desc",cmd:"mceMoveBackward"}),b.addButton("absolute",{title:"layer.absolute_desc",cmd:"mceMakeAbsolute"}),b.addButton("insertlayer",{title:"layer.insertlayer_desc",cmd:"mceInsertLayer"}),b.onInit.add(function(){var a=b.dom;tinymce.isIE&&b.getDoc().execCommand("2D-Position",!1,!0)}),b.onMouseUp.add(function(b,c){var d=a(c.target);d&&b.dom.setAttrib(d,"data-mce-style","")}),b.onMouseDown.add(function(b,c){var d,e=c.target,f=b.getDoc();tinymce.isGecko&&(a(e)?f.designMode!=="on"&&(f.designMode="on",e=f.body,d=e.parentNode,d.removeChild(e),d.appendChild(e)):f.designMode=="on"&&(f.designMode="off"))}),b.onNodeChange.add(c._nodeChange,c),b.onVisualAid.add(c._visualAid,c)},getInfo:function(){return{longname:"Layer",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/layer",version:tinymce.majorVersion+"."+tinymce.minorVersion}},_nodeChange:function(a,b,c){var d=this._getParentLayer(c),e=a.dom.getParent(c,"DIV,P,IMG");e?(b.setDisabled("absolute",0),b.setDisabled("moveforward",!d),b.setDisabled("movebackward",!d),b.setActive("absolute",d&&d.style.position.toLowerCase()=="absolute")):(b.setDisabled("absolute",1),b.setDisabled("moveforward",1),b.setDisabled("movebackward",1))},_visualAid:function(a,b,c){var d=a.dom;tinymce.each(d.select("div,p",b),function(a){/^(absolute|relative|fixed)$/i.test(a.style.position)&&(c?d.addClass(a,"mceItemVisualAid"):d.removeClass(a,"mceItemVisualAid"),d.addClass(a,"mceItemLayer"))})},_move:function(a){var b,c=this.editor,d=[],e=this._getParentLayer(c.selection.getNode()),f=-1,g=-1,h=[];tinymce.walk(c.getBody(),function(a){a.nodeType==1&&/^(absolute|relative|static)$/i.test(a.style.position)&&h.push(a)},"childNodes");for(b=0;b<h.length;b++)d[b]=h[b].style.zIndex?parseInt(h[b].style.zIndex):0,f<0&&h[b]==e&&(f=b);if(a<0){for(b=0;b<d.length;b++)if(d[b]<d[f]){g=b;break}g>-1?(h[f].style.zIndex=d[g],h[g].style.zIndex=d[f]):d[f]>0&&(h[f].style.zIndex=d[f]-1)}else{for(b=0;b<d.length;b++)if(d[b]>d[f]){g=b;break}g>-1?(h[f].style.zIndex=d[g],h[g].style.zIndex=d[f]):h[f].style.zIndex=d[f]+1}c.execCommand("mceRepaint")},_getParentLayer:function(a){return this.editor.dom.getParent(a,function(a){return a.nodeType==1&&/^(absolute|relative|static)$/i.test(a.style.position)})},_insertLayer:function(){var a=this.editor,b=a.dom,c=b.getPos(b.getParent(a.selection.getNode(),"*")),d=a.getBody();a.dom.add(d,"div",{style:{position:"absolute",left:c.x,top:c.y>20?c.y:20,width:100,height:100},"class":"mceItemVisualAid mceItemLayer"},a.selection.getContent()||a.getLang("layer.content")),tinymce.isIE&&b.setHTML(d,d.innerHTML)},_toggleAbsolute:function(){var a=this.editor,b=this._getParentLayer(a.selection.getNode());b||(b=a.dom.getParent(a.selection.getNode(),"DIV,P,IMG")),b&&(b.style.position.toLowerCase()=="absolute"?(a.dom.setStyles(b,{position:"",left:"",top:"",width:"",height:""}),a.dom.removeClass(b,"mceItemVisualAid"),a.dom.removeClass(b,"mceItemLayer")):(b.style.left==""&&(b.style.left="20px"),b.style.top==""&&(b.style.top="20px"),b.style.width==""&&(b.style.width=b.width?b.width+"px":"100px"),b.style.height==""&&(b.style.height=b.height?b.height+"px":"100px"),b.style.position="absolute",a.dom.setAttrib(b,"data-mce-style",""),a.addVisual(a.getBody())),a.execCommand("mceRepaint"),a.nodeChanged())}}),tinymce.PluginManager.add("layer",tinymce.plugins.Layer)})();