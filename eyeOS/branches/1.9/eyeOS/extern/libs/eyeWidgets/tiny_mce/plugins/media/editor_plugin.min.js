(function(){function g(a){var b,c;if(a&&!a.splice){b=[];for(c=0;!0;c++){if(!a[c])break;b[c]=a[c]}return b}return a}var a,b=tinymce.explode("id,name,width,height,style,align,class,hspace,vspace,bgcolor,type"),c=tinymce.makeMap(b.join(",")),d=tinymce.html.Node,e=tinymce.util.JSON,f=[["Flash","d27cdb6e-ae6d-11cf-96b8-444553540000","application/x-shockwave-flash","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["ShockWave","166b1bca-3f9c-11cf-8075-444553540000","application/x-director","http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0"],["WindowsMedia","6bf52a52-394a-11d3-b153-00c04f79faa6,22d6f312-b0f6-11d0-94ab-0080c74c7e95,05589fa1-c356-11ce-bf01-00aa0055595a","application/x-mplayer2","http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"],["QuickTime","02bf25d5-8c17-4b23-bc80-d3488abddc6b","video/quicktime","http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0"],["RealMedia","cfcdaa03-8be4-11cf-b84b-0020afbbccfa","audio/x-pn-realaudio-plugin","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["Java","8ad9c840-044e-11d1-b3e9-00805f499d93","application/x-java-applet","http://java.sun.com/products/plugin/autodl/jinstall-1_5_0-windows-i586.cab#Version=1,5,0,0"],["Silverlight","dfeaf541-f3e1-4c24-acac-99c30715084a","application/x-silverlight-2"],["Iframe"],["Video"],["EmbeddedAudio"],["Audio"]];tinymce.create("tinymce.plugins.MediaPlugin",{init:function(c,d){function m(a){return a&&a.nodeName==="IMG"&&c.dom.hasClass(a,"mceItemMedia")}var g,h,i,j,k=this,l={};k.editor=c,k.url=d,a="";for(g=0;g<f.length;g++){j=f[g][0],i={name:j,clsids:tinymce.explode(f[g][1]||""),mimes:tinymce.explode(f[g][2]||""),codebase:f[g][3]};for(h=0;h<i.clsids.length;h++)l["clsid:"+i.clsids[h]]=i;for(h=0;h<i.mimes.length;h++)l[i.mimes[h]]=i;l["mceItem"+j]=i,l[j.toLowerCase()]=i,a+=(a?"|":"")+j}tinymce.each(c.getParam("media_types","video=mp4,m4v,ogv,webm;silverlight=xap;flash=swf,flv;shockwave=dcr;quicktime=mov,qt,mpg,mpeg;shockwave=dcr;windowsmedia=avi,wmv,wm,asf,asx,wmx,wvx;realmedia=rm,ra,ram;java=jar;audio=mp3,ogg").split(";"),function(a){var b,c,d;a=a.split(/=/),c=tinymce.explode(a[1].toLowerCase());for(b=0;b<c.length;b++)d=l[a[0].toLowerCase()],d&&(l[c[b]]=d)}),a=RegExp("write("+a+")\\(([^)]+)\\)"),k.lookup=l,c.onPreInit.add(function(){c.schema.addValidElements("object[id|style|width|height|classid|codebase|*],param[name|value],embed[id|style|width|height|type|src|*],video[*],audio[*],source[*]"),c.parser.addNodeFilter("object,embed,video,audio,script,iframe",function(a){var b=a.length;while(b--)k.objectToImg(a[b])}),c.serializer.addNodeFilter("img",function(a,b,c){var d,e=a.length;while(e--)d=a[e],(d.attr("class")||"").indexOf("mceItemMedia")!==-1&&k.imgToObject(d,c)})}),c.onInit.add(function(){c.theme&&c.theme.onResolveName&&c.theme.onResolveName.add(function(a,b){b.name==="img"&&c.dom.hasClass(b.node,"mceItemMedia")&&(b.name="media")}),c&&c.plugins.contextmenu&&c.plugins.contextmenu.onContextMenu.add(function(a,b,c){c.nodeName==="IMG"&&c.className.indexOf("mceItemMedia")!==-1&&b.add({title:"media.edit",icon:"media",cmd:"mceMedia"})})}),c.addCommand("mceMedia",function(){var a,f=c.selection.getNode();m(f)&&(a=c.dom.getAttrib(f,"data-mce-json"),a&&(a=e.parse(a),tinymce.each(b,function(b){var d=c.dom.getAttrib(f,b);d&&(a[b]=d)}),a.type=k.getType(f.className).name.toLowerCase())),a||(a={type:"flash",video:{sources:[]},params:{}}),c.windowManager.open({file:d+"/media.htm",width:430+parseInt(c.getLang("media.delta_width",0)),height:500+parseInt(c.getLang("media.delta_height",0)),inline:1},{plugin_url:d,data:a})}),c.addButton("media",{title:"media.desc",cmd:"mceMedia"}),c.onNodeChange.add(function(a,b,c){b.setActive("media",m(c))})},convertUrl:function(a,b){var c=this,d=c.editor,e=d.settings,f=e.url_converter,g=e.url_converter_scope||c;return a?b?d.documentBaseURI.toAbsolute(a):f.call(g,a,"src","object"):a},getInfo:function(){return{longname:"Media",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media",version:tinymce.majorVersion+"."+tinymce.minorVersion}},dataToImg:function(a,b){var c,d,f,h,i=this,j=i.editor,k=j.documentBaseURI;a.params.src=i.convertUrl(a.params.src,b),d=a.video.attrs,d&&(d.src=i.convertUrl(d.src,b)),d&&(d.poster=i.convertUrl(d.poster,b)),c=g(a.video.sources);if(c)for(h=0;h<c.length;h++)c[h].src=i.convertUrl(c[h].src,b);return f=i.editor.dom.create("img",{id:a.id,style:a.style,align:a.align,hspace:a.hspace,vspace:a.vspace,src:i.editor.theme.url+"/img/trans.gif","class":"mceItemMedia mceItem"+i.getType(a.type).name,"data-mce-json":e.serialize(a,"'")}),f.width=a.width||(a.type=="audio"?"300":"320"),f.height=a.height||(a.type=="audio"?"32":"240"),f},dataToHtml:function(a,b){return this.editor.serializer.serialize(this.dataToImg(a,b),{forced_root_block:"",force_absolute:b})},htmlToData:function(a){var c={type:"flash",video:{sources:[]},params:{}},d=this.editor.parser.parse(a),f=d.getAll("img")[0];return f&&(c=e.parse(f.attr("data-mce-json")),c.type=this.getType(f.attr("class")).name.toLowerCase(),tinymce.each(b,function(a){var b=f.attr(a);b&&(c[a]=b)})),c},getType:function(a){var b,c,d=tinymce.explode(a," ");for(b=0;b<d.length;b++){c=this.lookup[d[b]];if(c)return c}},imgToObject:function(a,c){function z(a,b){var c,d,e,f,g=y.getParam("flash_video_player_url",x.convertUrl(x.url+"/moxieplayer.swf"));g&&(c=y.documentBaseURI,l.params.src=g,y.getParam("flash_video_player_absvideourl",!0)&&(a=c.toAbsolute(a||"",!0),b=c.toAbsolute(b||"",!0)),e="",d=y.getParam("flash_video_player_flashvars",{url:"$url",poster:"$poster"}),tinymce.each(d,function(c,d){c=c.replace(/\$url/,a||""),c=c.replace(/\$poster/,b||""),c.length>0&&(e+=(e?"&":"")+d+"="+escape(c))}),e.length&&(l.params.flashvars=e),f=y.getParam("flash_video_player_params",{allowfullscreen:!0,allowscriptaccess:!0}),tinymce.each(f,function(a,b){l.params[b]=""+a}))}var f,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x=this,y=x.editor;l=a.attr("data-mce-json");if(!l)return;l=e.parse(l),p=this.getType(a.attr("class")),u=a.attr("data-mce-style"),u||(u=a.attr("style"),u&&(u=y.dom.serializeStyle(y.dom.parseStyle(u,"img"))));if(p.name==="Iframe"){s=new d("iframe",1),tinymce.each(b,function(b){var c=a.attr(b);b=="class"&&c&&(c=c.replace(/mceItem.+ ?/g,"")),c&&c.length>0&&s.attr(b,c)});for(j in l.params)s.attr(j,l.params[j]);s.attr({style:u,src:l.params.src}),a.replace(s);return}if(this.editor.settings.media_use_script){s=(new d("script",1)).attr("type","text/javascript"),k=new d("#text",3),k.value="write"+p.name+"("+e.serialize(tinymce.extend(l.params,{width:a.attr("width"),height:a.attr("height")}))+");",s.append(k),a.replace(s);return}if(p.name==="Video"&&l.video.sources[0]){f=(new d("video",1)).attr(tinymce.extend({id:a.attr("id"),width:a.attr("width"),height:a.attr("height"),style:u},l.video.attrs)),l.video.attrs&&(t=l.video.attrs.poster),n=l.video.sources=g(l.video.sources);for(q=0;q<n.length;q++)/\.mp4$/.test(n[q].src)&&(r=n[q].src);n[0].type||(f.attr("src",n[0].src),n.splice(0,1));for(q=0;q<n.length;q++)m=(new d("source",1)).attr(n[q]),m.shortEnded=!0,f.append(m);r?(z(r,t),p=x.getType("flash")):l.params.src=""}if(p.name==="Audio"&&l.video.sources[0]){v=(new d("audio",1)).attr(tinymce.extend({id:a.attr("id"),width:a.attr("width"),height:a.attr("height"),style:u},l.video.attrs)),l.video.attrs&&(t=l.video.attrs.poster),n=l.video.sources=g(l.video.sources),n[0].type||(v.attr("src",n[0].src),n.splice(0,1));for(q=0;q<n.length;q++)m=(new d("source",1)).attr(n[q]),m.shortEnded=!0,v.append(m);l.params.src=""}if(p.name==="EmbeddedAudio"){i=new d("embed",1),i.shortEnded=!0,i.attr({id:a.attr("id"),width:a.attr("width"),height:a.attr("height"),style:u,type:a.attr("type")});for(j in l.params)i.attr(j,l.params[j]);tinymce.each(b,function(a){l[a]&&a!="type"&&i.attr(a,l[a])}),l.params.src=""}if(l.params.src){/\.flv$/i.test(l.params.src)&&z(l.params.src,""),c&&c.force_absolute&&(l.params.src=y.documentBaseURI.toAbsolute(l.params.src)),h=(new d("object",1)).attr({id:a.attr("id"),width:a.attr("width"),height:a.attr("height"),style:u}),tinymce.each(b,function(a){var b=l[a];a=="class"&&b&&(b=b.replace(/mceItem.+ ?/g,"")),b&&a!="type"&&h.attr(a,b)});for(j in l.params)o=new d("param",1),o.shortEnded=!0,k=l.params[j],j==="src"&&p.name==="WindowsMedia"&&(j="url"),o.attr({name:j,value:k}),h.append(o);if(this.editor.getParam("media_strict",!0))h.attr({data:l.params.src,type:p.mimes[0]});else{h.attr({classid:"clsid:"+p.clsids[0],codebase:p.codebase}),i=new d("embed",1),i.shortEnded=!0,i.attr({id:a.attr("id"),width:a.attr("width"),height:a.attr("height"),style:u,type:p.mimes[0]});for(j in l.params)i.attr(j,l.params[j]);tinymce.each(b,function(a){l[a]&&a!="type"&&i.attr(a,l[a])}),h.append(i)}l.object_html&&(k=new d("#text",3),k.raw=!0,k.value=l.object_html,h.append(k)),f&&f.append(h)}f&&l.video_html&&(k=new d("#text",3),k.raw=!0,k.value=l.video_html,f.append(k)),v&&l.video_html&&(k=new d("#text",3),k.raw=!0,k.value=l.video_html,v.append(k)),w=f||v||h||i,w?a.replace(w):a.remove()},objectToImg:function(f){function H(a){return(new tinymce.html.Serializer({inner:!0,validate:!1})).serialize(a)}function I(a,b){return E[(a.attr(b)||"").toLowerCase()]}function J(a){var b=a.replace(/^.*\.([^.]+)$/,"$1");return E[b.toLowerCase()||""]}var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E=this.lookup,F=this.editor.settings.url_converter,G=this.editor.settings.url_converter_scope;if(!f.parent)return;if(f.name==="script"){f.firstChild&&(y=a.exec(f.firstChild.value));if(!y)return;x=y[1],w={video:{},params:e.parse(y[2])},n=w.params.width,o=w.params.height}w=w||{video:{},params:{}},k=new d("img",1),k.attr({src:this.editor.theme.url+"/img/trans.gif"}),l=f.name;if(l==="video"||l=="audio"){i=f,g=f.getAll("object")[0],h=f.getAll("embed")[0],n=i.attr("width"),o=i.attr("height"),m=i.attr("id"),w.video={attrs:{},sources:[]},z=w.video.attrs;for(l in i.attributes.map)z[l]=i.attributes.map[l];u=f.attr("src"),u&&w.video.sources.push({src:F.call(G,u,"src",f.name)}),v=i.getAll("source");for(q=0;q<v.length;q++)u=v[q].remove(),w.video.sources.push({src:F.call(G,u.attr("src"),"src","source"),type:u.attr("type"),media:u.attr("media")});z.poster&&(z.poster=F.call(G,z.poster,"poster",f.name))}f.name==="object"&&(g=f,h=f.getAll("embed")[0]),f.name==="embed"&&(h=f),f.name==="iframe"&&(j=f,x="Iframe");if(g){n=n||g.attr("width"),o=o||g.attr("height"),p=p||g.attr("style"),m=m||g.attr("id"),A=A||g.attr("hspace"),B=B||g.attr("vspace"),C=C||g.attr("align"),D=D||g.attr("bgcolor"),w.name=g.attr("name"),t=g.getAll("param");for(q=0;q<t.length;q++)s=t[q],l=s.remove().attr("name"),c[l]||(w.params[l]=s.attr("value"));w.params.src=w.params.src||g.attr("data")}if(h){n=n||h.attr("width"),o=o||h.attr("height"),p=p||h.attr("style"),m=m||h.attr("id"),A=A||h.attr("hspace"),B=B||h.attr("vspace"),C=C||h.attr("align"),D=D||h.attr("bgcolor");for(l in h.attributes.map)!c[l]&&!w.params[l]&&(w.params[l]=h.attributes.map[l])}if(j){n=j.attr("width"),o=j.attr("height"),p=p||j.attr("style"),m=j.attr("id"),A=j.attr("hspace"),B=j.attr("vspace"),C=j.attr("align"),D=j.attr("bgcolor"),tinymce.each(b,function(a){k.attr(a,j.attr(a))});for(l in j.attributes.map)!c[l]&&!w.params[l]&&(w.params[l]=j.attributes.map[l])}w.params.movie&&(w.params.src=w.params.src||w.params.movie,delete w.params.movie),w.params.src&&(w.params.src=F.call(G,w.params.src,"src","object")),i&&(f.name==="video"?x=E.video.name:f.name==="audio"&&(x=E.audio.name)),g&&!x&&(x=(I(g,"clsid")||I(g,"classid")||I(g,"type")||{}).name),h&&!x&&(x=(I(h,"type")||J(w.params.src)||{}).name),h&&x=="EmbeddedAudio"&&(w.params.type=h.attr("type")),f.replace(k),h&&h.remove(),g&&(r=H(g.remove()),r&&(w.object_html=r)),i&&(r=H(i.remove()),r&&(w.video_html=r)),w.hspace=A,w.vspace=B,w.align=C,w.bgcolor=D,k.attr({id:m,"class":"mceItemMedia mceItem"+(x||"Flash"),style:p,width:n||(f.name=="audio"?"300":"320"),height:o||(f.name=="audio"?"32":"240"),hspace:A,vspace:B,align:C,bgcolor:D,"data-mce-json":e.serialize(w,"'")})}}),tinymce.PluginManager.add("media",tinymce.plugins.MediaPlugin)})();