(function(a){var b,c,d="autosave",e="restoredraft",f=!0,g=a.util.Dispatcher;a.create("tinymce.plugins.AutoSave",{init:function(h){function k(a){var b={s:1e3,m:6e4};return a=/^(\d+)([ms]?)$/.exec(""+a),(a[2]?b[a[2]]:1)*parseInt(a)}var i=this,j=h.settings;i.editor=h,a.each({ask_before_unload:f,interval:"30s",retention:"20m",minlength:50},function(a,c){c=d+"_"+c,j[c]===b&&(j[c]=a)}),j.autosave_interval=k(j.autosave_interval),j.autosave_retention=k(j.autosave_retention),h.addButton(e,{title:d+".restore_content",onclick:function(){h.getContent({draft:!0}).replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length>0?h.windowManager.confirm(d+".warning_message",function(a){a&&i.restoreDraft()}):i.restoreDraft()}}),h.onNodeChange.add(function(){var a=h.controlManager;a.get(e)&&a.setDisabled(e,!i.hasDraft())}),h.onInit.add(function(){h.controlManager.get(e)&&(i.setupStorage(h),setInterval(function(){i.storeDraft(),h.nodeChanged()},j.autosave_interval))}),i.onStoreDraft=new g(i),i.onRestoreDraft=new g(i),i.onRemoveDraft=new g(i),c||(window.onbeforeunload=a.plugins.AutoSave._beforeUnloadHandler,c=f)},getInfo:function(){return{longname:"Auto save",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/autosave",version:a.majorVersion+"."+a.minorVersion}},getExpDate:function(){return(new Date((new Date).getTime()+this.editor.settings.autosave_retention)).toUTCString()},setupStorage:function(b){var c=this,e=d+"_test",g="OK";c.key=d+b.id,a.each([function(){if(localStorage){localStorage.setItem(e,g);if(localStorage.getItem(e)===g)return localStorage.removeItem(e),localStorage}},function(){if(sessionStorage){sessionStorage.setItem(e,g);if(sessionStorage.getItem(e)===g)return sessionStorage.removeItem(e),sessionStorage}},function(){if(a.isIE)return b.getElement().style.behavior="url('#default#userData')",{autoExpires:f,setItem:function(a,d){var e=b.getElement();e.setAttribute(a,d),e.expires=c.getExpDate();try{e.save("TinyMCE")}catch(f){}},getItem:function(a){var c=b.getElement();try{return c.load("TinyMCE"),c.getAttribute(a)}catch(d){return null}},removeItem:function(a){b.getElement().removeAttribute(a)}}}],function(a){try{c.storage=a();if(c.storage)return!1}catch(b){}})},storeDraft:function(){var a,b,c=this,d=c.storage,e=c.editor;if(d){if(!d.getItem(c.key)&&!e.isDirty())return;b=e.getContent({draft:!0}),b.length>e.settings.autosave_minlength&&(a=c.getExpDate(),c.storage.autoExpires||c.storage.setItem(c.key+"_expires",a),c.storage.setItem(c.key,b),c.onStoreDraft.dispatch(c,{expires:a,content:b}))}},restoreDraft:function(){var a,b=this,c=b.storage;c&&(a=c.getItem(b.key),a&&(b.editor.setContent(a),b.onRestoreDraft.dispatch(b,{content:a})))},hasDraft:function(){var a,b,c=this,d=c.storage;if(d){b=!!d.getItem(c.key);if(b){if(!!c.storage.autoExpires)return f;a=new Date(d.getItem(c.key+"_expires"));if((new Date).getTime()<a.getTime())return f;c.removeDraft()}}return!1},removeDraft:function(){var a,b=this,c=b.storage,d=b.key;c&&(a=c.getItem(d),c.removeItem(d),c.removeItem(d+"_expires"),a&&b.onRemoveDraft.dispatch(b,{content:a}))},"static":{_beforeUnloadHandler:function(){var b;return a.each(tinyMCE.editors,function(a){a.plugins.autosave&&a.plugins.autosave.storeDraft();if(a.getParam("fullscreen_is_enabled"))return;!b&&a.isDirty()&&a.getParam("autosave_ask_before_unload")&&(b=a.getLang("autosave.unload_msg"))}),b}}}),a.PluginManager.add("autosave",a.plugins.AutoSave)})(tinymce);