(function(){var a=tinymce.util.JSONRequest,b=tinymce.each,c=tinymce.DOM;tinymce.create("tinymce.plugins.SpellcheckerPlugin",{getInfo:function(){return{longname:"Spellchecker",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/spellchecker",version:tinymce.majorVersion+"."+tinymce.minorVersion}},init:function(a,c){var d=this;d.url=c,d.editor=a,d.rpcUrl=a.getParam("spellchecker_rpc_url","{backend}");if(d.rpcUrl=="{backend}"){if(tinymce.isIE)return;d.hasSupport=!0,a.onContextMenu.addToTop(function(){if(d.active)return!1})}a.addCommand("mceSpellCheck",function(){if(d.rpcUrl=="{backend}"){d.editor.getBody().spellcheck=d.active=!d.active;return}d.active?d._done():(a.setProgressState(1),d._sendRPC("checkWords",[d.selectedLang,d._getWords()],function(b){b.length>0?(d.active=1,d._markWords(b),a.setProgressState(0),a.nodeChanged()):(a.setProgressState(0),a.getParam("spellchecker_report_no_misspellings",!0)&&a.windowManager.alert("spellchecker.no_mpell"))}))}),a.settings.content_css!==!1&&a.contentCSS.push(c+"/css/content.css"),a.onClick.add(d._showMenu,d),a.onContextMenu.add(d._showMenu,d),a.onBeforeGetContent.add(function(){d.active&&d._removeWords()}),a.onNodeChange.add(function(a,b){b.setActive("spellchecker",d.active)}),a.onSetContent.add(function(){d._done()}),a.onBeforeGetContent.add(function(){d._done()}),a.onBeforeExecCommand.add(function(a,b){b=="mceFullScreen"&&d._done()}),d.languages={},b(a.getParam("spellchecker_languages","+English=en,Danish=da,Dutch=nl,Finnish=fi,French=fr,German=de,Italian=it,Polish=pl,Portuguese=pt,Spanish=es,Swedish=sv","hash"),function(a,b){b.indexOf("+")===0&&(b=b.substring(1),d.selectedLang=a),d.languages[b]=a})},createControl:function(a,c){var d,e=this,f=e.editor;if(a=="spellchecker")return e.rpcUrl=="{backend}"?(e.hasSupport&&(d=c.createButton(a,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:e})),d):(d=c.createSplitButton(a,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:e}),d.onRenderMenu.add(function(a,c){c.add({title:"spellchecker.langs","class":"mceMenuItemTitle"}).setDisabled(1),b(e.languages,function(a,b){var d,f={icon:1};f.onclick=function(){if(a==e.selectedLang)return;d.setSelected(1),e.selectedItem.setSelected(0),e.selectedItem=d,e.selectedLang=a},f.title=b,d=c.add(f),d.setSelected(a==e.selectedLang),a==e.selectedLang&&(e.selectedItem=d)})}),d)},_walk:function(a,b){var c,d=this.editor.getDoc();if(d.createTreeWalker){c=d.createTreeWalker(a,NodeFilter.SHOW_TEXT,null,!1);while((a=c.nextNode())!=null)b.call(this,a)}else tinymce.walk(a,b,"childNodes")},_getSeparators:function(){var a,b="",c=this.editor.getParam("spellchecker_word_separator_chars",'\\s!"#$%&()*+,-./:;<=>?@[]^_{|}§©«®±¶·¸»¼½¾¿×÷¤”“');for(a=0;a<c.length;a++)b+="\\"+c.charAt(a);return b},_getWords:function(){var a=this.editor,c=[],d="",e={},f=[];return this._walk(a.getBody(),function(a){a.nodeType==3&&(d+=a.nodeValue+" ")}),a.getParam("spellchecker_word_pattern")?f=d.match("("+a.getParam("spellchecker_word_pattern")+")","gi"):(d=d.replace(RegExp("([0-9]|["+this._getSeparators()+"])","g")," "),d=tinymce.trim(d.replace(/(\s+)/g," ")),f=d.split(" ")),b(f,function(a){e[a]||(c.push(a),e[a]=1)}),c},_removeWords:function(a){var c=this.editor,d=c.dom,e=c.selection,f=e.getBookmark();b(d.select("span").reverse(),function(b){b&&(d.hasClass(b,"mceItemHiddenSpellWord")||d.hasClass(b,"mceItemHidden"))&&(!a||d.decode(b.innerHTML)==a)&&d.remove(b,1)}),e.moveToBookmark(f)},_markWords:function(a){var c=this.editor,d=c.dom,e=c.getDoc(),f=c.selection,g=f.getBookmark(),h=[],i=a.join("|"),j=this._getSeparators(),k=RegExp("(^|["+j+"])("+i+")(?=["+j+"]|$)","g");this._walk(c.getBody(),function(a){a.nodeType==3&&h.push(a)}),b(h,function(a){var b,c,f,g,h=a.nodeValue;if(k.test(h)){h=d.encode(h),c=d.create("span",{"class":"mceItemHidden"});if(tinymce.isIE){h=h.replace(k,"$1<mcespell>$2</mcespell>");while((g=h.indexOf("<mcespell>"))!=-1)f=h.substring(0,g),f.length&&(b=e.createTextNode(d.decode(f)),c.appendChild(b)),h=h.substring(g+10),g=h.indexOf("</mcespell>"),f=h.substring(0,g),h=h.substring(g+11),c.appendChild(d.create("span",{"class":"mceItemHiddenSpellWord"},f));h.length&&(b=e.createTextNode(d.decode(h)),c.appendChild(b))}else c.innerHTML=h.replace(k,'$1<span class="mceItemHiddenSpellWord">$2</span>');d.replace(c,a)}}),f.moveToBookmark(g)},_showMenu:function(a,d){var e,f=this,a=f.editor,g=f._menu,h=a.dom,i=h.getViewPort(a.getWin()),j=d.target;d=0,g||(g=a.controlManager.createDropMenu("spellcheckermenu",{"class":"mceNoIcons"}),f._menu=g);if(h.hasClass(j,"mceItemHiddenSpellWord"))return g.removeAll(),g.add({title:"spellchecker.wait","class":"mceMenuItemTitle"}).setDisabled(1),f._sendRPC("getSuggestions",[f.selectedLang,h.decode(j.innerHTML)],function(c){var d;g.removeAll(),c.length>0?(g.add({title:"spellchecker.sug","class":"mceMenuItemTitle"}).setDisabled(1),b(c,function(b){g.add({title:b,onclick:function(){h.replace(a.getDoc().createTextNode(b),j),f._checkDone()}})}),g.addSeparator()):g.add({title:"spellchecker.no_sug","class":"mceMenuItemTitle"}).setDisabled(1),a.getParam("show_ignore_words",!0)&&(d=f.editor.getParam("spellchecker_enable_ignore_rpc",""),g.add({title:"spellchecker.ignore_word",onclick:function(){var b=j.innerHTML;h.remove(j,1),f._checkDone(),d&&(a.setProgressState(1),f._sendRPC("ignoreWord",[f.selectedLang,b],function(){a.setProgressState(0)}))}}),g.add({title:"spellchecker.ignore_words",onclick:function(){var b=j.innerHTML;f._removeWords(h.decode(b)),f._checkDone(),d&&(a.setProgressState(1),f._sendRPC("ignoreWords",[f.selectedLang,b],function(){a.setProgressState(0)}))}})),f.editor.getParam("spellchecker_enable_learn_rpc")&&g.add({title:"spellchecker.learn_word",onclick:function(){var b=j.innerHTML;h.remove(j,1),f._checkDone(),a.setProgressState(1),f._sendRPC("learnWord",[f.selectedLang,b],function(){a.setProgressState(0)})}}),g.update()}),e=c.getPos(a.getContentAreaContainer()),g.settings.offset_x=e.x,g.settings.offset_y=e.y,a.selection.select(j),e=h.getPos(j),g.showMenu(e.x,e.y+j.offsetHeight-i.y),tinymce.dom.Event.cancel(d);g.hideMenu()},_checkDone:function(){var a,c=this,d=c.editor,e=d.dom;b(e.select("span"),function(b){if(b&&e.hasClass(b,"mceItemHiddenSpellWord"))return a=!0,!1}),a||c._done()},_done:function(){var a=this,b=a.active;a.active&&(a.active=0,a._removeWords(),a._menu&&a._menu.hideMenu(),b&&a.editor.nodeChanged())},_sendRPC:function(b,c,d){var e=this;a.sendRPC({url:e.rpcUrl,method:b,params:c,success:d,error:function(a,b){e.editor.setProgressState(0),e.editor.windowManager.alert(a.errstr||"Error response: "+b.responseText)}})}}),tinymce.PluginManager.add("spellchecker",tinymce.plugins.SpellcheckerPlugin)})();