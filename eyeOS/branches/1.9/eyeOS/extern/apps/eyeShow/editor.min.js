function slimeyClick(a){return this.slimey.editor.click(this),stopPropagation(a),!1}function slimeyHighlight(){this.className="slimeyHighlightedElement"}function slimeyLowshadow(){this==this.slimey.editor.getSelected()?this.className="slimeySelectedElement":this.className="slimeyElement"}function slimeyDrag(a){var a;return a||(a=window.event),this.slimey.editor.drag(this,a),stopPropagation(a),!1}function slimeyMove(a){var a;a||(a=window.event);try{this.slimey.editor.move(a),stopPropagation(a)}catch(a){}return!1}function slimeyDrop(){this.slimey.editor.drop()}function slimeyDeselect(){try{this.slimey.editor.deselect()}catch(a){}}function slimeyEdit(a){return this.slimey.editor.dblclick(this,a),stopPropagation(a),!1}var SlimeyEditor=function(a){this.slimey=a,this.current=null,this.selected=null,this.container=document.createElement("div"),this.container.id="Edcontainer",this.undoStack=new SlimeyStack,this.redoStack=new SlimeyStack,this.events=[],this.events.selectionChange=[],this.events.actionPerformed=[],this.contentEditor=document.createElement("textarea"),this.contentEditor.slimey=this.slimey,this.contentEditor.id="contentEditor",this.contentEditor.style.position="absolute",this.contentEditor.style.zIndex="20000",this.contentEditor.style.overflow="visible",this.contentEditor.style.visibility="hidden",this.contentEditor.style.top=-1e3,this.contentEditor.style.backgroundColor="#FFFFEE",this.contentEditor.systemElement=!0,this.container.appendChild(this.contentEditor),this.resizeHandle=document.createElement("div"),this.resizeHandle.slimey=this.slimey,this.resizeHandle.className="resizeHandle",this.resizeHandle.style.zIndex=1e8,this.resizeHandle.style.position="absolute",this.resizeHandle.style.visibility="hidden",this.resizeHandle.systemElement=!0,this.container.appendChild(this.resizeHandle),this.container.className="slimeyEditor",this.container.slimey=this.slimey,this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.padding="0px",this.container.style.overflow="hidden",this.container.style.fontSize="25px",this.container.style.cursor="default",this.container.style.width="640px",this.container.style.height="480px",this.container.style.fontSize="20px",setEventHandler(this.container,"mousemove",slimeyMove),setEventHandler(this.container,"mouseup",slimeyDrop),setEventHandler(this.container,"click",slimeyDeselect),setEventHandler(this.container,"resize",this.resized,this),addEventHandler(window,"resize",this.resized,this),addEventHandler(window,"load",this.resized,this),setEventHandler(this.resizeHandle,"mousedown",slimeyDrag),setEventHandler(this.contentEditor,"blur",function(){var a=this.value;this.editElement.tagName=="UL"||this.editElement.tagName=="OL"?(a="<li>"+a+"</li>",a=a.replace(/\n/g,"</li><li>")):this.editElement.tagName=="DIV"&&(a=a.replace(/\n/g,"<br>"));var b=new SlimeyEditContentAction(this.slimey,a,this.editElement);this.slimey.editor.performAction(b),this.style.visibility="hidden",this.style.top=-1e3,this.editElement=null}),setEventHandler(this.contentEditor,"keyup",function(a){if(!a)var a=window.event;a.keyCode==27&&this.onblur()}),setEventHandler(this.contentEditor,"click",function(a){return a||(a=window.event),stopPropagation(a),!1})};SlimeyEditor.prototype.getContainer=function(){return this.container},SlimeyEditor.prototype.getHTML=function(){var a,b;this.selected&&(this.selected.className="slimeyElement"),a="";for(b=this.container.firstChild;b;b=b.nextSibling)b.nodeType==1&&!b.systemElement&&(a+="<"+b.tagName.toLowerCase(),b.src&&(a+=' src="'+b.src+'"'),a+=' style="'+b.style.cssText+'"',a+=">\n",b.innerHTML&&(a+=b.innerHTML+"\n"),a+="</"+b.tagName.toLowerCase()+">\n");return this.selected&&(this.selected.className="slimeySelectedElement"),a},SlimeyEditor.prototype.setHTML=function(a){var b;this.deselect(),this.container.innerHTML=a;for(b=this.container.firstChild;b;b=b.nextSibling)b.nodeType==1&&(b.slimey=this.slimey,setEventHandler(b,"mousedown",slimeyDrag),setEventHandler(b,"click",slimeyClick),setEventHandler(b,"mouseover",slimeyHighlight),setEventHandler(b,"mouseout",slimeyLowshadow),setEventHandler(b,"dblclick",slimeyEdit),b.tagName=="IMG"?(b.resizable=!0,b.title=lang("drag the bottom right corner to resize")):(b.editable=!0,b.resizable=!0,b.title=lang("double click to edit content")),b.className="slimeyElement",b.style.zIndex||(b.style.zIndex=1e4),b.style.cursor="move");this.container.appendChild(this.resizeHandle),this.container.appendChild(this.contentEditor)},SlimeyEditor.prototype.getDOM=function(a){var b,c;for(b=0;b<this.container.childNodes.length;b++)c=this.container.childNodes.item(b),c.systemElement||(this.container.removeChild(c),b--,a.appendChild(c));return a},SlimeyEditor.prototype.setDOM=function(a){var b,c;this.deselect();for(b=0;b<this.container.childNodes.length;b++)c=this.container.childNodes.item(b),c.systemElement||(this.container.removeChild(c),b--);for(b=0;b<a.childNodes.length;b++)c=a.childNodes.item(b),a.removeChild(c),b--,this.container.appendChild(c)},SlimeyEditor.prototype.getSelected=function(){return this.selected},SlimeyEditor.prototype.select=function(a){this.selected&&this.deselect(),this.selected=a,a.className="slimeySelectedElement",this.fireEvent("selectionChange"),a.resizable&&(this.resizeHandle.style.visibility="visible",this.resizeHandle.style.left=getPercentValue(a.style.left)+getPercentValue(a.style.width)+"%",this.resizeHandle.style.top=getPercentValue(a.style.top)+getPercentValue(a.style.height)+"%")},SlimeyEditor.prototype.deselect=function(){this.selected&&(this.selected.className="slimeyElement"),this.selected=null,this.resizeHandle.style.visibility="hidden",this.fireEvent("selectionChange")},SlimeyEditor.prototype.performAction=function(a){a.perform(),this.undoStack.push(a),this.redoStack.clear(),this.fireEvent("actionPerformed")},SlimeyEditor.prototype.undo=function(){var a=this.undoStack.pop();a&&(a.undo(),this.redoStack.push(a)),this.fireEvent("actionPerformed")},SlimeyEditor.prototype.redo=function(){var a=this.redoStack.pop();a&&(a.perform(),this.undoStack.push(a)),this.fireEvent("actionPerformed")},SlimeyEditor.prototype.addEventListener=function(a,b,c){var d=this.events[a];d[d.length]={callback:b,scope:c}},SlimeyEditor.prototype.removeEventListener=function(a,b){var c=this.events[a];for(i=0;i<c.length;i++)c[i]==b&&(c.length>1&&(c[i]=c[c.length]),c.length--)},SlimeyEditor.prototype.fireEvent=function(a){var b=this.events[a];for(i=0;i<b.length;i++)b[i].callback.call(b[i].scope)},SlimeyEditor.prototype.click=function(a){a!=this.selected&&this.select(a)},SlimeyEditor.prototype.dblclick=function(a){var b;a!=this.selected&&this.select(a);if(!a.editable)return;this.contentEditor.editElement=a,this.contentEditor.style.visibility="visible",this.contentEditor.style.fontFamily=a.style.fontFamily,this.contentEditor.style.color=a.style.color,this.contentEditor.style.fontSize=a.style.fontSize,this.contentEditor.style.fontWeight=a.style.fontWeight,this.contentEditor.style.fontStyle=a.style.fontStyle,this.contentEditor.style.textDecoration=a.style.textDecoration,this.contentEditor.style.left=a.style.left,this.contentEditor.style.top=a.style.top,this.contentEditor.style.width=a.style.width,this.contentEditor.style.height=a.style.height,b=a.innerHTML,a.tagName=="UL"||a.tagName=="OL"?(b=b.replace(/<\/li><li>/gi,"\n"),b=b.replace(/<li>|<\/li>/gi,"")):a.tagName=="DIV"&&(b=b.replace(/<br>/gi,"\n")),this.contentEditor.value=b,this.contentEditor.focus()},SlimeyEditor.prototype.drag=function(a,b){var c,d,e,f,g;this.current=a,a.systemElement||this.select(a),c=getMousePosition(b,this.container),this.hSize=this.container.offsetWidth,this.vSize=this.container.offsetHeight,d=getPercentValue(a.style.left),e=getPercentValue(a.style.top),d>100&&(d=50),e>100&&(e=50),f=Math.round(d*this.hSize/100),g=Math.round(e*this.vSize/100),this.difx=c.x-f,this.dify=c.y-g,this.dragx=this.movex=d,this.dragy=this.movey=e},SlimeyEditor.prototype.move=function(a){var b;this.current&&(b=getMousePosition(a,this.container),this.movex=Math.round((b.x-this.difx)*100/this.hSize),this.movey=Math.round((b.y-this.dify)*100/this.vSize),this.current.style.left=this.movex+"%",this.current.style.top=this.movey+"%",this.printDebug("("+this.current.style.left+", "+this.current.style.top+")"),this.current.resizable&&(this.resizeHandle.style.left=getPercentValue(this.current.style.left)+getPercentValue(this.current.style.width)+"%",this.resizeHandle.style.top=getPercentValue(this.current.style.top)+getPercentValue(this.current.style.height)+"%")),this.current==this.resizeHandle&&(this.selected.style.width=getPercentValue(this.resizeHandle.style.left)-getPercentValue(this.selected.style.left)+"%",this.selected.style.height=getPercentValue(this.resizeHandle.style.top)-getPercentValue(this.selected.style.top)+"%")},SlimeyEditor.prototype.drop=function(){var a,b,c,d,e;if(this.current)if(!this.current.systemElement)this.current.style.position=="absolute"&&(this.dragx!=this.movex||this.dragy!=this.movey)&&(a=new SlimeyMoveAction(this.slimey,this.movex+"%",this.movey+"%",this.dragx+"%",this.dragy+"%"),this.performAction(a));else{b=getPercentValue(this.resizeHandle.style.left)-getPercentValue(this.selected.style.left)+"%",c=getPercentValue(this.resizeHandle.style.top)-getPercentValue(this.selected.style.top)+"%",d=this.dragx-getPercentValue(this.selected.style.left)+"%",e=this.dragy-getPercentValue(this.selected.style.top)+"%";if(b!=d||c!=e)a=new SlimeyResizeAction(this.slimey,b,c,d,e),this.performAction(a),this.contentEditor.editElement&&(this.contentEditor.style.width=b,this.contentEditor.style.height=c)}this.current=null},SlimeyEditor.prototype.resized=function(){var a=this.container.offsetHeight;this.container.style.fontSize=a/24+"px"},SlimeyEditor.prototype.printDebug=function(){};